---
// src/pages/build-swarmv3/index.astro
// Hidden Build Swarm v3 dashboard — no navigation links point here
// Access: /build-swarmv3/

import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const title = "Build Swarm v3 | ArgoBox";
const description = "Build Swarm v3 control plane dashboard for distributed Gentoo package builds.";
---

<BaseLayout {title} {description} noindex={true}>
  <Header slot="header" />
  <main class="sv3">
    <!-- Header with Tabs -->
    <header class="sv3-header">
      <div class="sv3-header-inner">
        <div class="sv3-title">
          <span class="sv3-title-icon">&#x2699;&#xFE0F;</span>
          <span>Build Swarm <strong>v3</strong></span>
        </div>

        <nav class="sv3-tabs" role="tablist">
          <button class="sv3-tab active" role="tab" data-tab="overview" aria-selected="true">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            <span>Overview</span>
          </button>
          <button class="sv3-tab" role="tab" data-tab="architecture" aria-selected="false">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
            <span>Architecture</span>
          </button>
          <button class="sv3-tab" role="tab" data-tab="topology" aria-selected="false">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><circle cx="5" cy="19" r="3"/><circle cx="19" cy="19" r="3"/><line x1="12" y1="8" x2="5" y2="16"/><line x1="12" y1="8" x2="19" y2="16"/></svg>
            <span>Topology</span>
          </button>
          <button class="sv3-tab" role="tab" data-tab="fleet" aria-selected="false">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            <span>Fleet</span>
          </button>
          <button class="sv3-tab" role="tab" data-tab="queue" aria-selected="false">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            <span>Queue</span>
          </button>
          <button class="sv3-tab" role="tab" data-tab="history" aria-selected="false">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span>History</span>
          </button>
          <button class="sv3-tab" role="tab" data-tab="wire" aria-selected="false">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/><circle cx="12" cy="12" r="1"/></svg>
            <span>Wire</span>
          </button>
        </nav>

        <button class="sv3-replay-mode-btn" id="replay-mode-btn" title="Toggle Replay Mode">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <span id="replay-mode-label">Replay</span>
        </button>
        <div class="sv3-status" id="connection-status">
          <span class="sv3-status-dot"></span>
          <span class="sv3-status-text">Connecting...</span>
        </div>
      </div>
    </header>

    <!-- Replay Controls -->
    <div class="sv3-replay-controls" id="replay-controls" style="display:none;">
      <div class="sv3-replay-bar">
        <button class="sv3-replay-btn" id="replay-start" title="Jump to start">|&lt;</button>
        <button class="sv3-replay-btn" id="replay-back" title="Back 10s">&lt;&lt;</button>
        <button class="sv3-replay-btn" id="replay-play" title="Play/Pause">&#9654;</button>
        <button class="sv3-replay-btn" id="replay-fwd" title="Forward 10s">&gt;&gt;</button>
        <button class="sv3-replay-btn" id="replay-end" title="Jump to end">&gt;|</button>
        <select class="sv3-replay-speed" id="replay-speed">
          <option value="0.5">0.5x</option>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="5">5x</option>
          <option value="10">10x</option>
        </select>
        <span class="sv3-replay-time" id="replay-time">--:--:--</span>
      </div>
      <div class="sv3-replay-scrubber-wrap">
        <canvas class="sv3-replay-density" id="replay-density-canvas" width="800" height="40"></canvas>
        <input type="range" class="sv3-replay-scrubber" id="replay-scrubber" min="0" max="1000" value="0">
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="sv3-main">
      <div class="sv3-content">

        <!-- ========== OVERVIEW TAB ========== -->
        <div class="sv3-tab-content active" id="tab-overview" role="tabpanel">
          <!-- Summary Cards -->
          <div class="sv3-cards-row" id="overview-cards">
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Drones Online</div>
              <div class="sv3-stat-value" id="stat-drones">--</div>
            </div>
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Total Cores</div>
              <div class="sv3-stat-value" id="stat-cores">--</div>
            </div>
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Queue Depth</div>
              <div class="sv3-stat-value" id="stat-queue">--</div>
            </div>
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Received</div>
              <div class="sv3-stat-value sv3-stat-green" id="stat-received">--</div>
            </div>
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Blocked</div>
              <div class="sv3-stat-value sv3-stat-amber" id="stat-blocked">--</div>
            </div>
          </div>

          <!-- Session Info -->
          <div class="sv3-session-panel" id="session-panel" style="display:none;">
            <div class="sv3-session-header">
              <span>Active Session</span>
              <span class="sv3-session-id" id="session-id"></span>
            </div>
            <div class="sv3-session-body">
              <div class="sv3-session-row">
                <span class="sv3-session-label">Profile</span>
                <span class="sv3-session-val" id="session-profile">--</span>
              </div>
              <div class="sv3-session-row">
                <span class="sv3-session-label">Progress</span>
                <span class="sv3-session-val" id="session-progress">--</span>
              </div>
              <div class="sv3-session-progress-bar">
                <div class="sv3-session-progress-fill" id="session-progress-fill" style="width:0%"></div>
              </div>
              <div class="sv3-session-row">
                <span class="sv3-session-label">Elapsed</span>
                <span class="sv3-session-val" id="session-elapsed">--</span>
              </div>
              <div class="sv3-session-row">
                <span class="sv3-session-label">ETA</span>
                <span class="sv3-session-val" id="session-eta">--</span>
              </div>
            </div>
          </div>

          <!-- Queue Chart -->
          <div class="sv3-chart-card">
            <div class="sv3-chart-header">
              <span>Queue Depth Over Time</span>
            </div>
            <div class="sv3-chart-body" id="queue-chart"></div>
          </div>

          <!-- Build Rate Chart -->
          <div class="sv3-chart-card" style="margin-top:1rem;">
            <div class="sv3-chart-header">
              <span>Build Rate (per minute)</span>
            </div>
            <div class="sv3-chart-body" id="build-rate-chart"></div>
          </div>

          <!-- Fleet CPU Gauge -->
          <div class="sv3-chart-card" style="margin-top:1rem;">
            <div class="sv3-chart-title">Fleet CPU Utilization</div>
            <div class="sv3-gauge-wrap">
              <svg viewBox="0 0 200 120" class="sv3-gauge">
                <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="rgba(148,163,184,0.1)" stroke-width="12" stroke-linecap="round"/>
                <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#06b6d4" stroke-width="12" stroke-linecap="round" id="cpu-gauge-arc" stroke-dasharray="0 251"/>
              </svg>
              <div class="sv3-gauge-value" id="cpu-gauge-val">--%</div>
              <div class="sv3-gauge-label">avg across fleet</div>
            </div>
          </div>
        </div>

        <!-- ========== ARCHITECTURE TAB ========== -->
        <div class="sv3-tab-content" id="tab-architecture" role="tabpanel">
          <!-- Version Stepper -->
          <div class="sv3-arch-stepper">
            <button class="sv3-arch-step" data-arch="v1">
              <span class="sv3-arch-step-num">v1</span>
              <span class="sv3-arch-step-label">Hardcoded</span>
            </button>
            <div class="sv3-arch-step-line"></div>
            <button class="sv3-arch-step" data-arch="v2">
              <span class="sv3-arch-step-num">v2</span>
              <span class="sv3-arch-step-label">Gateway</span>
            </button>
            <div class="sv3-arch-step-line"></div>
            <button class="sv3-arch-step active" data-arch="v3">
              <span class="sv3-arch-step-num">v3</span>
              <span class="sv3-arch-step-label">Control Plane</span>
            </button>
          </div>

          <!-- Architecture Diagrams Container -->
          <div class="sv3-arch-diagrams">

            <!-- v1 Hardcoded Hell -->
            <div class="sv3-arch-diagram" id="arch-v1">
              <svg viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" class="sv3-arch-svg">
                <defs>
                  <filter id="v1-glow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                <!-- Client -->
                <rect x="330" y="20" width="140" height="50" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="1.5"/>
                <text x="400" y="50" text-anchor="middle" fill="#f1f5f9" font-size="13" font-weight="600">Client</text>
                <!-- Orchestrator -->
                <rect x="310" y="160" width="180" height="60" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="1.5"/>
                <text x="400" y="185" text-anchor="middle" fill="#f1f5f9" font-size="13" font-weight="600">Orchestrator</text>
                <text x="400" y="205" text-anchor="middle" fill="#64748b" font-size="10">Single point of failure</text>
                <!-- Drones row -->
                <rect x="40" y="340" width="130" height="50" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4 2"/>
                <text x="105" y="370" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone A</text>
                <rect x="220" y="340" width="130" height="50" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4 2"/>
                <text x="285" y="370" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone B</text>
                <rect x="440" y="340" width="130" height="50" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4 2"/>
                <text x="505" y="370" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone C</text>
                <rect x="630" y="340" width="130" height="50" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4 2"/>
                <text x="695" y="370" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone D</text>
                <!-- Tangled red dashed connections -->
                <line x1="400" y1="70" x2="400" y2="160" stroke="#ef4444" stroke-width="1" stroke-dasharray="6 3" opacity="0.7"/>
                <line x1="350" y1="220" x2="105" y2="340" stroke="#ef4444" stroke-width="1" stroke-dasharray="6 3" opacity="0.6"/>
                <line x1="370" y1="220" x2="285" y2="340" stroke="#ef4444" stroke-width="1" stroke-dasharray="6 3" opacity="0.6"/>
                <line x1="430" y1="220" x2="505" y2="340" stroke="#ef4444" stroke-width="1" stroke-dasharray="6 3" opacity="0.6"/>
                <line x1="460" y1="220" x2="695" y2="340" stroke="#ef4444" stroke-width="1" stroke-dasharray="6 3" opacity="0.6"/>
                <!-- Crossing mess lines -->
                <line x1="310" y1="190" x2="695" y2="340" stroke="#ef4444" stroke-width="0.8" stroke-dasharray="4 4" opacity="0.35"/>
                <line x1="490" y1="190" x2="105" y2="340" stroke="#ef4444" stroke-width="0.8" stroke-dasharray="4 4" opacity="0.35"/>
                <line x1="105" y1="390" x2="505" y2="390" stroke="#ef4444" stroke-width="0.6" stroke-dasharray="3 3" opacity="0.25"/>
                <!-- Hardcoded IP labels -->
                <text x="200" y="275" fill="#ef4444" font-size="9" font-family="monospace" opacity="0.8" transform="rotate(-20, 200, 275)">10.0.0.201</text>
                <text x="520" y="290" fill="#ef4444" font-size="9" font-family="monospace" opacity="0.8" transform="rotate(15, 520, 290)">10.0.0.203</text>
                <text x="600" y="270" fill="#ef4444" font-size="9" font-family="monospace" opacity="0.8" transform="rotate(25, 600, 270)">10.0.0.194</text>
                <!-- Callout annotations -->
                <rect x="580" y="100" width="180" height="30" rx="6" fill="rgba(239,68,68,0.1)" stroke="#ef4444" stroke-width="0.5"/>
                <text x="670" y="120" text-anchor="middle" fill="#ef4444" font-size="10">No discovery</text>
                <rect x="30" y="240" width="200" height="30" rx="6" fill="rgba(239,68,68,0.1)" stroke="#ef4444" stroke-width="0.5"/>
                <text x="130" y="260" text-anchor="middle" fill="#ef4444" font-size="10">Config files everywhere</text>
                <rect x="580" y="430" width="180" height="30" rx="6" fill="rgba(239,68,68,0.1)" stroke="#ef4444" stroke-width="0.5"/>
                <text x="670" y="450" text-anchor="middle" fill="#ef4444" font-size="10">No health checks</text>
              </svg>
            </div>

            <!-- v2 Gateway Era -->
            <div class="sv3-arch-diagram" id="arch-v2">
              <svg viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" class="sv3-arch-svg">
                <!-- Gateway -->
                <rect x="310" y="20" width="180" height="55" rx="8" fill="#1e293b" stroke="#22c55e" stroke-width="2"/>
                <text x="400" y="45" text-anchor="middle" fill="#22c55e" font-size="13" font-weight="600">Gateway</text>
                <text x="400" y="62" text-anchor="middle" fill="#64748b" font-size="9">Altair-Link</text>
                <!-- Primary Orchestrator -->
                <rect x="180" y="170" width="170" height="55" rx="8" fill="#1e293b" stroke="#f59e0b" stroke-width="2"/>
                <text x="265" y="195" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="600">Primary Orch</text>
                <text x="265" y="212" text-anchor="middle" fill="#64748b" font-size="9">Izar</text>
                <!-- Standby Orchestrator -->
                <rect x="440" y="170" width="170" height="55" rx="8" fill="#1e293b" stroke="#64748b" stroke-width="1.5" stroke-dasharray="4 2"/>
                <text x="525" y="195" text-anchor="middle" fill="#94a3b8" font-size="12" font-weight="600">Standby Orch</text>
                <text x="525" y="212" text-anchor="middle" fill="#64748b" font-size="9">Tarn (cold)</text>
                <!-- Drones -->
                <rect x="40" y="330" width="130" height="50" rx="8" fill="#1e293b" stroke="rgba(148,163,184,0.3)" stroke-width="1"/>
                <text x="105" y="360" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone A</text>
                <rect x="220" y="330" width="130" height="50" rx="8" fill="#1e293b" stroke="rgba(148,163,184,0.3)" stroke-width="1"/>
                <text x="285" y="360" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone B</text>
                <rect x="440" y="330" width="130" height="50" rx="8" fill="#1e293b" stroke="rgba(148,163,184,0.3)" stroke-width="1"/>
                <text x="505" y="360" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone C</text>
                <rect x="630" y="330" width="130" height="50" rx="8" fill="#1e293b" stroke="rgba(148,163,184,0.3)" stroke-width="1"/>
                <text x="695" y="360" text-anchor="middle" fill="#f1f5f9" font-size="12">Drone D</text>
                <!-- Hub-and-spoke lines -->
                <line x1="370" y1="75" x2="265" y2="170" stroke="#22c55e" stroke-width="1.5" opacity="0.7"/>
                <line x1="430" y1="75" x2="525" y2="170" stroke="#22c55e" stroke-width="1.5" opacity="0.4"/>
                <line x1="265" y1="225" x2="105" y2="330" stroke="#94a3b8" stroke-width="1" opacity="0.5"/>
                <line x1="265" y1="225" x2="285" y2="330" stroke="#94a3b8" stroke-width="1" opacity="0.5"/>
                <line x1="265" y1="225" x2="505" y2="330" stroke="#94a3b8" stroke-width="1" opacity="0.5"/>
                <line x1="265" y1="225" x2="695" y2="330" stroke="#94a3b8" stroke-width="1" opacity="0.5"/>
                <!-- Problem callout boxes -->
                <rect x="20" y="430" width="280" height="50" rx="8" fill="rgba(245,158,11,0.08)" stroke="#f59e0b" stroke-width="0.8"/>
                <text x="160" y="453" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="500">State in memory (lost on crash)</text>
                <text x="160" y="470" text-anchor="middle" fill="#64748b" font-size="9">No persistence layer</text>
                <rect x="490" y="430" width="280" height="50" rx="8" fill="rgba(245,158,11,0.08)" stroke="#f59e0b" stroke-width="0.8"/>
                <text x="630" y="453" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="500">Config drift (70% of debug time)</text>
                <text x="630" y="470" text-anchor="middle" fill="#64748b" font-size="9">Manual drone registration</text>
              </svg>
            </div>

            <!-- v3 Control Plane (default/active) -->
            <div class="sv3-arch-diagram active" id="arch-v3">
              <svg viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet" class="sv3-arch-svg">
                <defs>
                  <radialGradient id="cp-glow" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#06b6d4" stop-opacity="0.15"/><stop offset="100%" stop-color="#06b6d4" stop-opacity="0"/></radialGradient>
                  <filter id="v3-glow"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                <!-- Glow behind control plane -->
                <circle cx="400" cy="160" r="120" fill="url(#cp-glow)"/>
                <!-- Control Plane node -->
                <rect x="300" y="100" width="200" height="80" rx="12" fill="#0f172a" stroke="#06b6d4" stroke-width="2" filter="url(#v3-glow)"/>
                <text x="400" y="130" text-anchor="middle" fill="#06b6d4" font-size="14" font-weight="700">Control Plane</text>
                <!-- SQLite cylinder icon -->
                <ellipse cx="400" cy="155" rx="18" ry="6" fill="none" stroke="#06b6d4" stroke-width="1" opacity="0.6"/>
                <line x1="382" y1="155" x2="382" y2="168" stroke="#06b6d4" stroke-width="1" opacity="0.6"/>
                <line x1="418" y1="155" x2="418" y2="168" stroke="#06b6d4" stroke-width="1" opacity="0.6"/>
                <ellipse cx="400" cy="168" rx="18" ry="6" fill="none" stroke="#06b6d4" stroke-width="1" opacity="0.6"/>
                <!-- Drones in semicircle -->
                <rect x="60" y="340" width="120" height="55" rx="8" fill="#0f172a" stroke="#06b6d4" stroke-width="1.5"/>
                <text x="120" y="365" text-anchor="middle" fill="#f1f5f9" font-size="11" font-weight="500">Drone Izar</text>
                <text x="120" y="382" text-anchor="middle" fill="#64748b" font-size="9">16 cores</text>
                <rect x="220" y="390" width="120" height="55" rx="8" fill="#0f172a" stroke="#06b6d4" stroke-width="1.5"/>
                <text x="280" y="415" text-anchor="middle" fill="#f1f5f9" font-size="11" font-weight="500">Drone Tau</text>
                <text x="280" y="432" text-anchor="middle" fill="#64748b" font-size="9">8 cores</text>
                <rect x="450" y="390" width="120" height="55" rx="8" fill="#0f172a" stroke="#06b6d4" stroke-width="1.5"/>
                <text x="510" y="415" text-anchor="middle" fill="#f1f5f9" font-size="11" font-weight="500">Drone Tarn</text>
                <text x="510" y="432" text-anchor="middle" fill="#64748b" font-size="9">14 cores</text>
                <rect x="610" y="340" width="130" height="55" rx="8" fill="#0f172a" stroke="#06b6d4" stroke-width="1.5"/>
                <text x="675" y="365" text-anchor="middle" fill="#f1f5f9" font-size="11" font-weight="500">Drone Meridian</text>
                <text x="675" y="382" text-anchor="middle" fill="#64748b" font-size="9">24 cores</text>
                <!-- Connection paths -->
                <path d="M 400,180 Q 250,260 120,340" stroke="#06b6d4" stroke-width="1.2" fill="none" opacity="0.4"/>
                <path d="M 400,180 Q 340,300 280,390" stroke="#06b6d4" stroke-width="1.2" fill="none" opacity="0.4"/>
                <path d="M 400,180 Q 460,300 510,390" stroke="#06b6d4" stroke-width="1.2" fill="none" opacity="0.4"/>
                <path d="M 400,180 Q 540,260 675,340" stroke="#06b6d4" stroke-width="1.2" fill="none" opacity="0.4"/>
                <!-- Animated dots (CP -> drone) -->
                <circle r="4" fill="#06b6d4" filter="url(#v3-glow)"><animateMotion dur="3s" repeatCount="indefinite" path="M 400,180 Q 250,260 120,340"/></circle>
                <circle r="4" fill="#06b6d4" filter="url(#v3-glow)"><animateMotion dur="3.5s" repeatCount="indefinite" path="M 400,180 Q 340,300 280,390" begin="0.8s"/></circle>
                <circle r="4" fill="#06b6d4" filter="url(#v3-glow)"><animateMotion dur="3.2s" repeatCount="indefinite" path="M 400,180 Q 460,300 510,390" begin="1.5s"/></circle>
                <circle r="4" fill="#06b6d4" filter="url(#v3-glow)"><animateMotion dur="2.8s" repeatCount="indefinite" path="M 400,180 Q 540,260 675,340" begin="0.4s"/></circle>
                <!-- Return dots (drone -> CP) -->
                <circle r="3" fill="#22c55e" opacity="0.8"><animateMotion dur="3s" repeatCount="indefinite" path="M 120,340 Q 250,260 400,180" begin="1.5s"/></circle>
                <circle r="3" fill="#22c55e" opacity="0.8"><animateMotion dur="3.5s" repeatCount="indefinite" path="M 675,340 Q 540,260 400,180" begin="2s"/></circle>
                <!-- Feature labels -->
                <rect x="80" y="470" width="150" height="30" rx="6" fill="rgba(6,182,212,0.08)" stroke="#06b6d4" stroke-width="0.5"/>
                <text x="155" y="490" text-anchor="middle" fill="#06b6d4" font-size="10">SQLite persistence</text>
                <rect x="320" y="480" width="150" height="30" rx="6" fill="rgba(6,182,212,0.08)" stroke="#06b6d4" stroke-width="0.5"/>
                <text x="395" y="500" text-anchor="middle" fill="#06b6d4" font-size="10">Circuit breaker</text>
                <rect x="560" y="470" width="150" height="30" rx="6" fill="rgba(6,182,212,0.08)" stroke="#06b6d4" stroke-width="0.5"/>
                <text x="635" y="490" text-anchor="middle" fill="#06b6d4" font-size="10">Auto-rebalance</text>
              </svg>
            </div>
          </div>

          <!-- What Changed Cards -->
          <div class="sv3-arch-changes" id="arch-changes">
            <div class="sv3-arch-change-card" data-for="v1"><div class="sv3-arch-change-icon" style="color:#ef4444;">&#x2717;</div><div class="sv3-arch-change-body"><div class="sv3-arch-change-title">Hardcoded IPs in every config</div><div class="sv3-arch-change-desc">Adding a drone meant editing files on every node. One typo bricked the cluster.</div></div></div>
            <div class="sv3-arch-change-card" data-for="v1"><div class="sv3-arch-change-icon" style="color:#ef4444;">&#x2717;</div><div class="sv3-arch-change-body"><div class="sv3-arch-change-title">Zero observability</div><div class="sv3-arch-change-desc">No health checks, no metrics, no idea if a drone was alive or stuck.</div></div></div>
            <div class="sv3-arch-change-card" data-for="v2"><div class="sv3-arch-change-icon" style="color:#f59e0b;">&#x26A0;</div><div class="sv3-arch-change-body"><div class="sv3-arch-change-title">Gateway centralized routing</div><div class="sv3-arch-change-desc">Hub-and-spoke was cleaner but the gateway was a single point of failure.</div></div></div>
            <div class="sv3-arch-change-card" data-for="v2"><div class="sv3-arch-change-icon" style="color:#f59e0b;">&#x26A0;</div><div class="sv3-arch-change-body"><div class="sv3-arch-change-title">State lived in memory</div><div class="sv3-arch-change-desc">Crash the orchestrator, lose everything. Config drift ate 70% of debug time.</div></div></div>
            <div class="sv3-arch-change-card" data-for="v3"><div class="sv3-arch-change-icon" style="color:#06b6d4;">&#x2713;</div><div class="sv3-arch-change-body"><div class="sv3-arch-change-title">SQLite-backed control plane</div><div class="sv3-arch-change-desc">Every state change persisted. Restart the service, pick up exactly where you left off.</div></div></div>
            <div class="sv3-arch-change-card" data-for="v3"><div class="sv3-arch-change-icon" style="color:#06b6d4;">&#x2713;</div><div class="sv3-arch-change-body"><div class="sv3-arch-change-title">Auto-discovery + circuit breaker</div><div class="sv3-arch-change-desc">Drones register themselves. Unhealthy nodes get fenced automatically.</div></div></div>
          </div>
        </div>

        <!-- ========== TOPOLOGY TAB ========== -->
        <div class="sv3-tab-content" id="tab-topology" role="tabpanel">
          <div class="sv3-topo-layout">
            <div class="sv3-topo-main">
              <svg id="sv3-topo-svg" class="sv3-topo-svg" viewBox="0 0 1200 600" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <radialGradient id="topo-glow-purple"><stop offset="0%" stop-color="#8b5cf6" stop-opacity="1"/><stop offset="100%" stop-color="#8b5cf6" stop-opacity="0"/></radialGradient>
                  <radialGradient id="topo-glow-green"><stop offset="0%" stop-color="#22c55e" stop-opacity="1"/><stop offset="100%" stop-color="#22c55e" stop-opacity="0"/></radialGradient>
                  <radialGradient id="topo-glow-cyan"><stop offset="0%" stop-color="#06b6d4" stop-opacity="1"/><stop offset="100%" stop-color="#06b6d4" stop-opacity="0"/></radialGradient>
                  <filter id="topo-node-glow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                  <pattern id="topo-grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(6,182,212,0.04)" stroke-width="1"/></pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#topo-grid)"/>
                <g id="sv3-topo-connections"></g>
                <g id="sv3-topo-packets"></g>
                <g id="sv3-topo-nodes"></g>
              </svg>
            </div>
            <div class="sv3-topo-sidebar">
              <div class="sv3-topo-stat-card"><div class="sv3-topo-stat-label">Cores Online</div><div class="sv3-topo-stat-value" id="topo-cores">--</div></div>
              <div class="sv3-topo-stat-card"><div class="sv3-topo-stat-label">Queue Throughput</div><div class="sv3-topo-stat-value" id="topo-throughput">--</div></div>
              <div class="sv3-topo-stat-card"><div class="sv3-topo-stat-label">Active Builds</div><div class="sv3-topo-stat-value" id="topo-active">--</div></div>
              <div class="sv3-topo-stat-card"><div class="sv3-topo-stat-label">Uptime</div><div class="sv3-topo-stat-value" id="topo-uptime">--</div></div>
              <div class="sv3-topo-legend">
                <div class="sv3-topo-legend-title">Packet Legend</div>
                <div class="sv3-topo-legend-item"><span class="sv3-topo-legend-dot" style="background:#8b5cf6;"></span><span>Work Request (CP &rarr; Drone)</span></div>
                <div class="sv3-topo-legend-item"><span class="sv3-topo-legend-dot" style="background:#22c55e;"></span><span>Completion (Drone &rarr; CP)</span></div>
                <div class="sv3-topo-legend-item"><span class="sv3-topo-legend-dot" style="background:#06b6d4;"></span><span>Heartbeat (Drone &harr; CP)</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ========== FLEET TAB ========== -->
        <div class="sv3-tab-content" id="tab-fleet" role="tabpanel">
          <div class="sv3-fleet-grid" id="fleet-grid">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- ========== QUEUE TAB ========== -->
        <div class="sv3-tab-content" id="tab-queue" role="tabpanel">
          <!-- Status Breakdown Bar -->
          <div class="sv3-queue-breakdown" id="queue-breakdown">
            <div class="sv3-breakdown-bar">
              <div class="sv3-breakdown-seg needed" id="seg-needed" style="width:0%"></div>
              <div class="sv3-breakdown-seg delegated" id="seg-delegated" style="width:0%"></div>
              <div class="sv3-breakdown-seg received" id="seg-received" style="width:0%"></div>
              <div class="sv3-breakdown-seg blocked" id="seg-blocked" style="width:0%"></div>
            </div>
            <div class="sv3-breakdown-legend">
              <span class="sv3-legend-item"><span class="sv3-legend-dot needed"></span> Needed <span id="legend-needed">0</span></span>
              <span class="sv3-legend-item"><span class="sv3-legend-dot delegated"></span> Delegated <span id="legend-delegated">0</span></span>
              <span class="sv3-legend-item"><span class="sv3-legend-dot received"></span> Received <span id="legend-received">0</span></span>
              <span class="sv3-legend-item"><span class="sv3-legend-dot blocked"></span> Blocked <span id="legend-blocked">0</span></span>
            </div>
          </div>

          <!-- Control Buttons -->
          <div class="sv3-controls">
            <button class="sv3-ctrl-btn pause" data-action="pause">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
              Pause
            </button>
            <button class="sv3-ctrl-btn resume" data-action="resume">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Resume
            </button>
            <button class="sv3-ctrl-btn unblock" data-action="unblock_all">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 11V7a5 5 0 0 1 9.9-1"/><rect x="3" y="11" width="18" height="11" rx="2"/></svg>
              Unblock All
            </button>
            <button class="sv3-ctrl-btn rebalance" data-action="rebalance">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
              Rebalance
            </button>
          </div>

          <!-- Package Table -->
          <div class="sv3-table-wrap">
            <table class="sv3-table" id="queue-table">
              <thead>
                <tr>
                  <th>Package</th>
                  <th>Status</th>
                  <th>Assigned To</th>
                  <th>Failures</th>
                </tr>
              </thead>
              <tbody id="queue-tbody">
                <tr class="sv3-empty-row"><td colspan="4">No queue data</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ========== HISTORY TAB ========== -->
        <div class="sv3-tab-content" id="tab-history" role="tabpanel">
          <!-- Stats Summary -->
          <div class="sv3-cards-row sv3-history-stats">
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Avg Build Time</div>
              <div class="sv3-stat-value" id="hist-avg-time">--</div>
            </div>
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Success Rate</div>
              <div class="sv3-stat-value sv3-stat-green" id="hist-success-rate">--</div>
            </div>
            <div class="sv3-stat-card">
              <div class="sv3-stat-label">Total Builds</div>
              <div class="sv3-stat-value" id="hist-total">--</div>
            </div>
          </div>

          <!-- Build Duration Histogram -->
          <div class="sv3-chart-card" style="margin-bottom:1.5rem;">
            <div class="sv3-chart-title">Build Duration Distribution</div>
            <div class="sv3-histogram" id="duration-histogram">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Drone Performance Breakdown -->
          <div class="sv3-chart-card" style="margin-bottom:1.5rem;">
            <div class="sv3-chart-title">Drone Performance</div>
            <div class="sv3-drone-perf" id="drone-perf">
              <!-- Populated by JS from stats.per_drone -->
            </div>
          </div>

          <!-- History Table -->
          <div class="sv3-table-wrap">
            <table class="sv3-table" id="history-table">
              <thead>
                <tr>
                  <th>Package</th>
                  <th>Drone</th>
                  <th>Status</th>
                  <th>Duration</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="history-tbody">
                <tr class="sv3-empty-row"><td colspan="5">No history data</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ========== WIRE TAB ========== -->
        <div class="sv3-tab-content" id="tab-wire" role="tabpanel">
          <div class="sv3-wire-filters">
            <div class="sv3-wire-filter-row">
              <select id="wire-filter-type" class="sv3-wire-select">
                <option value="">All Types</option>
                <option value="work_request">work_request</option>
                <option value="register">register</option>
                <option value="complete">complete</option>
                <option value="discovery">discovery</option>
                <option value="status_query">status_query</option>
                <option value="events_query">events_query</option>
                <option value="queue">queue</option>
                <option value="control">control</option>
                <option value="node_list">node_list</option>
                <option value="metrics_query">metrics_query</option>
                <option value="history_query">history_query</option>
                <option value="health_check">health_check</option>
                <option value="node_pause">node_pause</option>
                <option value="node_resume">node_resume</option>
                <option value="node_delete">node_delete</option>
                <option value="provisioning">provisioning</option>
              </select>
              <select id="wire-filter-drone" class="sv3-wire-select">
                <option value="">All Drones</option>
              </select>
              <input type="text" id="wire-filter-package" class="sv3-wire-input" placeholder="Package filter...">
              <input type="number" id="wire-filter-latency" class="sv3-wire-input sv3-wire-input-sm" placeholder="Min ms">
              <label class="sv3-wire-live-toggle">
                <input type="checkbox" id="wire-live" checked>
                <span class="sv3-wire-live-dot"></span>
                Live
              </label>
              <button id="wire-clear-filters" class="sv3-wire-clear-btn">Clear</button>
            </div>
            <div class="sv3-wire-stats" id="wire-stats"></div>
          </div>
          <div class="sv3-wire-split" id="wire-split">
            <div class="sv3-wire-list-wrap" id="wire-list-wrap">
              <table class="sv3-wire-table">
                <thead>
                  <tr>
                    <th class="sv3-wire-th-id">#</th>
                    <th class="sv3-wire-th-time">Time</th>
                    <th>Source</th>
                    <th class="sv3-wire-th-arrow"></th>
                    <th>Type</th>
                    <th>Summary</th>
                    <th>Latency</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="wire-tbody">
                  <tr class="sv3-empty-row"><td colspan="8">No protocol data — waiting for traffic...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="sv3-wire-resize" id="wire-resize-handle"></div>
            <div class="sv3-wire-detail" id="wire-detail">
              <div class="sv3-wire-detail-empty" id="wire-detail-empty">Select a packet to inspect</div>
              <div class="sv3-wire-detail-content" id="wire-detail-content" style="display:none;">
                <div class="sv3-wire-detail-header" id="wire-detail-header"></div>
                <div class="sv3-wire-detail-tabs">
                  <button class="sv3-wire-dtab active" data-dtab="request">Request</button>
                  <button class="sv3-wire-dtab" data-dtab="response">Response</button>
                  <button class="sv3-wire-dtab" data-dtab="meta">Meta</button>
                </div>
                <pre class="sv3-wire-json" id="wire-json"></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Offline Banner -->
        <div class="sv3-offline-banner" id="offline-banner" style="display:none;">
          <div class="sv3-offline-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
          </div>
          <div class="sv3-offline-text">
            <strong>Control plane offline</strong>
            <span>Unable to reach v3 API at 10.42.0.199:8100 &mdash; retrying every 5s</span>
          </div>
        </div>

      </div>

      <!-- Activity Feed Panel -->
      <div class="sv3-activity-panel" id="activity-panel">
        <div class="sv3-activity-header" id="activity-header">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          <span>Activity Feed</span>
          <span class="sv3-activity-count" id="activity-count">0</span>
          <div class="sv3-activity-filters">
            <button class="sv3-af-filter active" data-filter="all">All</button>
            <button class="sv3-af-filter" data-filter="builds">Builds</button>
            <button class="sv3-af-filter" data-filter="errors">Errors</button>
            <button class="sv3-af-filter" data-filter="system">System</button>
          </div>
          <button class="sv3-activity-toggle" id="activity-toggle">...</button>
        </div>
        <div class="sv3-activity-body" id="activity-body">
          <div class="sv3-activity-entries" id="activity-entries"></div>
        </div>
      </div>
    </div>
  </main>
  <Footer slot="footer" />
</BaseLayout>

<!-- =========================================================================
     STYLES
     ========================================================================= -->
<style is:global>
  /* ---- Variables (reuse control-center palette) ---- */
  .sv3 {
    --bg: #030712;
    --surface: rgba(15, 23, 42, 0.4);
    --surface-hover: rgba(15, 23, 42, 0.6);
    --border: rgba(255, 255, 255, 0.08);
    --border-hover: rgba(255, 255, 255, 0.15);
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --text-dim: #64748b;
    --online: #22c55e;
    --offline: #ef4444;
    --building: #f59e0b;
    --idle: #64748b;
    --cyan: #06b6d4;
    --purple: #8b5cf6;
    --pink: #db2777;
    --green: #22c55e;
    --amber: #f59e0b;
    --gap: 1rem;
    --pad: 1.5rem;
    --radius: 12px;
    --ease: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ---- Layout ---- */
  .sv3 {
    min-height: 100vh;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .sv3 * { box-sizing: border-box; }

  /* ---- Header ---- */
  .sv3-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgba(3, 7, 18, 0.92);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem var(--pad);
  }

  .sv3-header-inner {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .sv3-title {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 1.15rem;
    color: var(--text);
  }
  .sv3-title strong { color: var(--cyan); }
  .sv3-title-icon { font-size: 1.3rem; }

  /* ---- Tabs ---- */
  .sv3-tabs {
    display: flex;
    gap: 0.25rem;
    background: var(--surface);
    border-radius: 8px;
    padding: 4px;
  }

  .sv3-tab {
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    border-radius: 6px;
    transition: var(--ease);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: inherit;
  }
  .sv3-tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
  .sv3-tab.active { color: var(--text); background: rgba(6, 182, 212, 0.2); }
  .sv3-tab svg { flex-shrink: 0; }

  /* ---- Connection Status ---- */
  .sv3-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--text-muted);
    flex-shrink: 0;
  }
  .sv3-status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--idle);
    transition: background 0.3s;
  }
  .sv3-status.live .sv3-status-dot {
    background: var(--online);
    box-shadow: 0 0 8px var(--online);
    animation: sv3-pulse 2s ease-in-out infinite;
  }
  .sv3-status.live .sv3-status-text { color: var(--online); }
  .sv3-status.offline .sv3-status-dot { background: var(--offline); }
  .sv3-status.offline .sv3-status-text { color: var(--offline); }

  @keyframes sv3-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* ---- Main ---- */
  .sv3-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .sv3-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--pad);
    -webkit-overflow-scrolling: touch;
    position: relative;
  }
  .sv3-tab-content {
    display: none;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
  }
  .sv3-tab-content.active {
    display: block;
    animation: sv3-fadeIn 0.25s ease;
  }
  @keyframes sv3-fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ---- Stat Cards ---- */
  .sv3-cards-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--gap);
    margin-bottom: 1.5rem;
  }
  .sv3-stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem 1rem;
    backdrop-filter: blur(12px);
    transition: border-color var(--ease), background var(--ease);
  }
  .sv3-stat-card:hover {
    border-color: var(--border-hover);
    background: var(--surface-hover);
  }
  .sv3-stat-label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.4rem;
  }
  .sv3-stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    color: var(--text);
  }
  .sv3-stat-green { color: var(--green); }
  .sv3-stat-amber { color: var(--amber); }

  /* ---- Session Panel ---- */
  .sv3-session-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
    overflow: hidden;
  }
  .sv3-session-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: rgba(6, 182, 212, 0.08);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 0.9rem;
  }
  .sv3-session-id {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  .sv3-session-body { padding: 1rem; }
  .sv3-session-row {
    display: flex;
    justify-content: space-between;
    padding: 0.3rem 0;
    font-size: 0.85rem;
  }
  .sv3-session-label { color: var(--text-dim); }
  .sv3-session-val { color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; }
  .sv3-session-progress-bar {
    height: 6px;
    background: rgba(255,255,255,0.08);
    border-radius: 3px;
    margin: 0.5rem 0;
    overflow: hidden;
  }
  .sv3-session-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--cyan), var(--green));
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  /* ---- Chart Card ---- */
  .sv3-chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .sv3-chart-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text);
  }
  .sv3-chart-body {
    height: 260px;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    font-size: 0.85rem;
  }

  /* ---- Fleet Grid ---- */
  .sv3-fleet-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--gap);
  }

  .sv3-drone-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem;
    backdrop-filter: blur(12px);
    transition: border-color var(--ease), box-shadow var(--ease);
  }
  .sv3-drone-card:hover {
    border-color: var(--cyan);
    box-shadow: 0 0 20px rgba(6, 182, 212, 0.12);
  }
  .sv3-drone-card.offline-card:hover {
    border-color: var(--offline);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.1);
  }

  .sv3-drone-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }
  .sv3-drone-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
  }
  .sv3-drone-ip {
    font-size: 0.75rem;
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
  }
  .sv3-drone-badge {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.72rem;
    font-weight: 500;
  }
  .sv3-drone-badge.online { background: rgba(34,197,94,0.15); color: var(--online); }
  .sv3-drone-badge.offline { background: rgba(239,68,68,0.15); color: var(--offline); }
  .sv3-drone-badge.draining { background: rgba(245,158,11,0.15); color: var(--amber); }
  .sv3-drone-badge-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: currentColor;
  }
  .sv3-drone-badge.online .sv3-drone-badge-dot {
    animation: sv3-pulse 2s ease-in-out infinite;
  }

  .sv3-drone-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.6rem;
    margin-bottom: 0.75rem;
  }
  .sv3-drone-metric-label {
    font-size: 0.65rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 0.15rem;
  }
  .sv3-drone-metric-bar {
    height: 5px;
    background: rgba(255,255,255,0.08);
    border-radius: 3px;
    overflow: hidden;
  }
  .sv3-drone-metric-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
    background: var(--cyan);
  }
  .sv3-drone-metric-fill.warn { background: var(--amber); }
  .sv3-drone-metric-fill.crit { background: var(--offline); }
  .sv3-drone-metric-val {
    font-size: 0.8rem;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text);
    margin-top: 0.1rem;
  }

  .sv3-drone-task {
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    padding: 0.6rem 0.75rem;
    margin-bottom: 0.6rem;
  }
  .sv3-drone-task-label {
    font-size: 0.65rem;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 0.15rem;
  }
  .sv3-drone-task-val {
    font-size: 0.82rem;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text);
  }
  .sv3-drone-task-val.idle {
    color: var(--text-muted);
    font-style: italic;
  }

  .sv3-drone-foot {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.6rem;
    border-top: 1px solid var(--border);
    font-size: 0.7rem;
    color: var(--text-dim);
  }
  .sv3-drone-cores {
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    background: rgba(6,182,212,0.1);
    color: var(--cyan);
    font-family: 'JetBrains Mono', monospace;
  }

  /* ---- Queue Tab ---- */
  .sv3-queue-breakdown { margin-bottom: 1.5rem; }
  .sv3-breakdown-bar {
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    display: flex;
    background: rgba(255,255,255,0.05);
    margin-bottom: 0.75rem;
  }
  .sv3-breakdown-seg {
    height: 100%;
    transition: width 0.5s ease;
  }
  .sv3-breakdown-seg.needed   { background: var(--cyan); }
  .sv3-breakdown-seg.delegated { background: var(--purple); }
  .sv3-breakdown-seg.received  { background: var(--green); }
  .sv3-breakdown-seg.blocked   { background: var(--amber); }

  .sv3-breakdown-legend {
    display: flex;
    gap: 1.5rem;
    font-size: 0.78rem;
    color: var(--text-muted);
    flex-wrap: wrap;
  }
  .sv3-legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .sv3-legend-dot {
    width: 8px; height: 8px;
    border-radius: 2px;
  }
  .sv3-legend-dot.needed   { background: var(--cyan); }
  .sv3-legend-dot.delegated { background: var(--purple); }
  .sv3-legend-dot.received  { background: var(--green); }
  .sv3-legend-dot.blocked   { background: var(--amber); }

  .sv3-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  .sv3-ctrl-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-size: 0.82rem;
    font-family: inherit;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--ease);
  }
  .sv3-ctrl-btn:hover {
    background: var(--surface-hover);
    color: var(--text);
    border-color: var(--border-hover);
  }
  .sv3-ctrl-btn.pause:hover { border-color: var(--amber); color: var(--amber); }
  .sv3-ctrl-btn.resume:hover { border-color: var(--green); color: var(--green); }
  .sv3-ctrl-btn.unblock:hover { border-color: var(--purple); color: var(--purple); }
  .sv3-ctrl-btn.rebalance:hover { border-color: var(--cyan); color: var(--cyan); }
  .sv3-ctrl-btn:active { transform: scale(0.97); }

  /* ---- Tables ---- */
  .sv3-table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
  }
  .sv3-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }
  .sv3-table thead {
    background: rgba(0,0,0,0.25);
  }
  .sv3-table th {
    padding: 0.65rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .sv3-table td {
    padding: 0.6rem 1rem;
    color: var(--text);
    border-bottom: 1px solid rgba(255,255,255,0.03);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
  }
  .sv3-table tbody tr:hover {
    background: rgba(255,255,255,0.02);
  }
  .sv3-empty-row td {
    text-align: center;
    color: var(--text-dim);
    padding: 2rem;
    font-style: italic;
    font-family: inherit;
  }

  .sv3-status-pill {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .sv3-status-pill.needed   { background: rgba(6,182,212,0.15); color: var(--cyan); }
  .sv3-status-pill.delegated { background: rgba(139,92,246,0.15); color: var(--purple); }
  .sv3-status-pill.received  { background: rgba(34,197,94,0.15); color: var(--green); }
  .sv3-status-pill.blocked   { background: rgba(245,158,11,0.15); color: var(--amber); }
  .sv3-status-pill.success   { background: rgba(34,197,94,0.15); color: var(--green); }
  .sv3-status-pill.failed    { background: rgba(239,68,68,0.15); color: var(--offline); }
  .sv3-status-pill.skipped   { background: rgba(100,116,139,0.15); color: var(--idle); }

  /* ---- Chart Title (shared) ---- */
  .sv3-chart-title {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text);
  }

  /* ---- Fleet CPU Gauge ---- */
  .sv3-gauge-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem 1rem 1rem;
    position: relative;
  }
  .sv3-gauge {
    width: 200px;
    height: 120px;
  }
  #cpu-gauge-arc {
    transition: stroke-dasharray 0.6s ease;
  }
  .sv3-gauge-value {
    font-size: 2rem;
    font-weight: 700;
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    color: var(--text);
    margin-top: -2rem;
    text-align: center;
  }
  .sv3-gauge-label {
    font-size: 0.72rem;
    color: var(--text-dim);
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ---- Activity Feed Panel ---- */
  .sv3-activity-panel {
    flex-shrink: 0;
    height: 200px;
    display: flex;
    flex-direction: column;
    background: rgba(3, 7, 18, 0.95);
    border-top: 1px solid var(--border);
    transition: height 0.25s ease;
    overflow: hidden;
  }
  .sv3-activity-panel.collapsed {
    height: 36px;
  }
  .sv3-activity-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    height: 36px;
    flex-shrink: 0;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 0.8rem;
    font-weight: 600;
    background: rgba(15, 23, 42, 0.6);
    border-bottom: 1px solid var(--border);
    user-select: none;
  }
  .sv3-activity-header:hover {
    background: rgba(15, 23, 42, 0.8);
    color: var(--text);
  }
  .sv3-activity-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 18px;
    padding: 0 5px;
    border-radius: 9px;
    background: rgba(6, 182, 212, 0.2);
    color: var(--cyan);
    font-size: 0.68rem;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
  }
  .sv3-activity-filters {
    display: flex;
    gap: 2px;
    margin-left: auto;
    margin-right: 0.5rem;
  }
  .sv3-af-filter {
    padding: 2px 8px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-size: 0.68rem;
    font-family: inherit;
    border-radius: 4px;
    cursor: pointer;
    transition: var(--ease);
  }
  .sv3-af-filter:hover {
    color: var(--text-muted);
    background: rgba(255,255,255,0.05);
  }
  .sv3-af-filter.active {
    color: var(--cyan);
    background: rgba(6, 182, 212, 0.15);
  }
  .sv3-activity-toggle {
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-size: 1rem;
    cursor: pointer;
    padding: 0 4px;
    line-height: 1;
    font-family: inherit;
  }
  .sv3-activity-body {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    -webkit-overflow-scrolling: touch;
  }
  .sv3-activity-entries {
    display: flex;
    flex-direction: column;
  }
  .sv3-activity-entry {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.3rem 1rem;
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    font-size: 0.75rem;
    color: var(--text-muted);
    border-left: 3px solid transparent;
    transition: background 0.15s;
  }
  .sv3-activity-entry:hover {
    background: rgba(255,255,255,0.02);
  }
  .sv3-activity-entry .sv3-ae-time {
    flex-shrink: 0;
    color: var(--text-dim);
    font-size: 0.7rem;
    min-width: 70px;
  }
  .sv3-activity-entry .sv3-ae-badge {
    flex-shrink: 0;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 0.62rem;
    font-weight: 600;
    text-transform: uppercase;
    min-width: 60px;
    text-align: center;
  }
  .sv3-activity-entry .sv3-ae-msg {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text);
  }
  /* Type-specific colors */
  .sv3-activity-entry[data-type="assign"],
  .sv3-activity-entry[data-type="queue"] {
    border-left-color: #06b6d4;
  }
  .sv3-activity-entry[data-type="assign"] .sv3-ae-badge,
  .sv3-activity-entry[data-type="queue"] .sv3-ae-badge {
    background: rgba(6,182,212,0.15);
    color: #06b6d4;
  }
  .sv3-activity-entry[data-type="complete"] {
    border-left-color: #22c55e;
  }
  .sv3-activity-entry[data-type="complete"] .sv3-ae-badge {
    background: rgba(34,197,94,0.15);
    color: #22c55e;
  }
  .sv3-activity-entry[data-type="fail"],
  .sv3-activity-entry[data-type="grounded"] {
    border-left-color: #ef4444;
  }
  .sv3-activity-entry[data-type="fail"] .sv3-ae-badge,
  .sv3-activity-entry[data-type="grounded"] .sv3-ae-badge {
    background: rgba(239,68,68,0.15);
    color: #ef4444;
  }
  .sv3-activity-entry[data-type="rebalance"],
  .sv3-activity-entry[data-type="reclaim"] {
    border-left-color: #f59e0b;
  }
  .sv3-activity-entry[data-type="rebalance"] .sv3-ae-badge,
  .sv3-activity-entry[data-type="reclaim"] .sv3-ae-badge {
    background: rgba(245,158,11,0.15);
    color: #f59e0b;
  }
  .sv3-activity-entry[data-type="register"],
  .sv3-activity-entry[data-type="control"] {
    border-left-color: #8b5cf6;
  }
  .sv3-activity-entry[data-type="register"] .sv3-ae-badge,
  .sv3-activity-entry[data-type="control"] .sv3-ae-badge {
    background: rgba(139,92,246,0.15);
    color: #8b5cf6;
  }
  .sv3-activity-entry.hidden {
    display: none;
  }

  /* ---- Histogram (History Tab) ---- */
  .sv3-histogram {
    padding: 1rem;
  }
  .sv3-histo-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    font-size: 0.75rem;
  }
  .sv3-histo-label {
    flex-shrink: 0;
    width: 60px;
    text-align: right;
    color: var(--text-dim);
  }
  .sv3-histo-bar-wrap {
    flex: 1;
    height: 20px;
    background: rgba(255,255,255,0.03);
    border-radius: 4px;
    overflow: hidden;
  }
  .sv3-histo-bar {
    height: 100%;
    border-radius: 4px;
    min-width: 2px;
    transition: width 0.4s ease;
  }
  .sv3-histo-count {
    flex-shrink: 0;
    width: 30px;
    color: var(--text-muted);
    font-weight: 600;
  }

  /* ---- Drone Performance (History Tab) ---- */
  .sv3-drone-perf {
    padding: 1rem;
  }
  .sv3-dp-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.6rem;
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    font-size: 0.75rem;
  }
  .sv3-dp-name {
    flex-shrink: 0;
    width: 100px;
    color: var(--text);
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .sv3-dp-bar-wrap {
    flex: 1;
    height: 16px;
    background: rgba(255,255,255,0.05);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }
  .sv3-dp-bar-fill {
    height: 100%;
    border-radius: 4px;
    background: var(--green);
    transition: width 0.4s ease;
  }
  .sv3-dp-bar-label {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.65rem;
    color: var(--text);
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
  }
  .sv3-dp-builds {
    flex-shrink: 0;
    width: 50px;
    text-align: right;
    color: var(--text-muted);
  }
  .sv3-dp-avg {
    flex-shrink: 0;
    width: 60px;
    text-align: right;
    color: var(--text-dim);
  }
  .sv3-dp-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 1.5rem;
    font-style: italic;
    font-family: inherit;
    font-size: 0.82rem;
  }

  /* ---- Offline Banner ---- */
  .sv3-offline-banner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem 2rem;
    background: rgba(239, 68, 68, 0.08);
    border: 1px solid rgba(239, 68, 68, 0.25);
    border-radius: var(--radius);
    z-index: 10;
  }
  .sv3-offline-icon { color: var(--offline); flex-shrink: 0; }
  .sv3-offline-text {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .sv3-offline-text strong {
    color: var(--offline);
    font-size: 1rem;
  }
  .sv3-offline-text span {
    color: var(--text-dim);
    font-size: 0.82rem;
  }

  /* ---- Responsive ---- */
  @media (max-width: 1024px) {
    .sv3-header-inner { flex-wrap: wrap; }
    .sv3-tabs { order: 3; width: 100%; justify-content: center; margin-top: 0.5rem; }
  }
  @media (max-width: 768px) {
    .sv3 { --pad: 1rem; }
    .sv3-tab span:not(svg) { display: none; }
    .sv3-cards-row { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
    .sv3-fleet-grid { grid-template-columns: 1fr; }
  }
  @media (pointer: coarse) {
    .sv3-tab { min-height: 44px; }
    .sv3-ctrl-btn { min-height: 44px; }
  }
  @media (prefers-reduced-motion: reduce) {
    .sv3-status.live .sv3-status-dot,
    .sv3-drone-badge.online .sv3-drone-badge-dot { animation: none; }
    .sv3-tab-content.active { animation: none; }
  }

  /* ---- uPlot overrides ---- */
  .sv3-chart-body .uplot { width: 100% !important; }
  .sv3-chart-body .u-legend { font-size: 0.72rem; color: var(--text-muted); }
  .sv3-chart-body .u-legend .u-marker { width: 10px; height: 3px; }

  /* ---- Architecture Tab ---- */
  .sv3-arch-stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    margin-bottom: 2rem;
  }
  .sv3-arch-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.6rem 1.5rem;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-family: inherit;
    font-size: 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.25s ease;
  }
  .sv3-arch-step:hover {
    border-color: var(--border-hover);
    color: var(--text);
    background: var(--surface-hover);
  }
  .sv3-arch-step.active {
    border-color: var(--cyan);
    background: rgba(6,182,212,0.12);
    color: var(--text);
  }
  .sv3-arch-step-num {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 0.9rem;
  }
  .sv3-arch-step.active .sv3-arch-step-num { color: var(--cyan); }
  .sv3-arch-step-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .sv3-arch-step-line {
    width: 40px;
    height: 2px;
    background: var(--border);
    flex-shrink: 0;
  }

  .sv3-arch-diagrams {
    position: relative;
    min-height: 400px;
    margin-bottom: 2rem;
  }
  .sv3-arch-diagram {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }
  .sv3-arch-diagram.active {
    opacity: 1;
    pointer-events: auto;
    position: relative;
  }
  .sv3-arch-svg {
    width: 100%;
    max-height: 520px;
    display: block;
  }

  .sv3-arch-changes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--gap);
  }
  .sv3-arch-change-card {
    display: none;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    backdrop-filter: blur(12px);
    transition: border-color var(--ease);
  }
  .sv3-arch-change-card.visible {
    display: flex;
  }
  .sv3-arch-change-card:hover {
    border-color: var(--border-hover);
  }
  .sv3-arch-change-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
    line-height: 1;
  }
  .sv3-arch-change-body { flex: 1; min-width: 0; }
  .sv3-arch-change-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.2rem;
  }
  .sv3-arch-change-desc {
    font-size: 0.78rem;
    color: var(--text-muted);
    line-height: 1.4;
  }

  /* ---- Topology Tab ---- */
  .sv3-topo-layout {
    display: flex;
    gap: var(--gap);
    min-height: 600px;
  }
  .sv3-topo-main {
    flex: 1;
    min-width: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .sv3-topo-svg {
    width: 100%;
    height: 100%;
    display: block;
    min-height: 500px;
  }
  .sv3-topo-sidebar {
    width: 200px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: var(--gap);
  }
  .sv3-topo-stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    backdrop-filter: blur(12px);
    transition: border-color var(--ease);
  }
  .sv3-topo-stat-card:hover {
    border-color: var(--border-hover);
  }
  .sv3-topo-stat-label {
    font-size: 0.65rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.3rem;
  }
  .sv3-topo-stat-value {
    font-size: 1.4rem;
    font-weight: 700;
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    color: var(--text);
  }
  .sv3-topo-legend {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    margin-top: auto;
  }
  .sv3-topo-legend-title {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.6rem;
  }
  .sv3-topo-legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.4rem;
  }
  .sv3-topo-legend-item:last-child { margin-bottom: 0; }
  .sv3-topo-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Topology node styles (SVG text) */
  .sv3-topo-node-label {
    font-size: 11px;
    font-weight: 600;
    fill: #f1f5f9;
  }
  .sv3-topo-node-sub {
    font-size: 9px;
    fill: #64748b;
    font-family: 'JetBrains Mono', monospace;
  }
  .sv3-topo-node-pkg {
    font-size: 8px;
    fill: #f59e0b;
    font-family: 'JetBrains Mono', monospace;
  }
  .sv3-topo-cpu-bar {
    transition: width 0.5s ease;
  }

  @media (max-width: 768px) {
    .sv3-topo-layout { flex-direction: column; }
    .sv3-topo-sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; }
    .sv3-topo-stat-card { flex: 1; min-width: 120px; }
    .sv3-topo-legend { width: 100%; }
    .sv3-arch-stepper { flex-wrap: wrap; gap: 0.5rem; }
    .sv3-arch-step-line { display: none; }
  }

  /* ===== Wire Tab ===== */
  .sv3-wire-filters {
    margin-bottom: 0.75rem;
  }
  .sv3-wire-filter-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 0.5rem;
  }
  .sv3-wire-select,
  .sv3-wire-input {
    padding: 0.4rem 0.6rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 0.78rem;
    font-family: 'JetBrains Mono', monospace;
    outline: none;
    transition: border-color var(--ease);
  }
  .sv3-wire-select:focus,
  .sv3-wire-input:focus {
    border-color: var(--cyan);
  }
  .sv3-wire-input-sm { width: 80px; }
  .sv3-wire-live-toggle {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.78rem;
    color: var(--text-muted);
    cursor: pointer;
    user-select: none;
  }
  .sv3-wire-live-toggle input { display: none; }
  .sv3-wire-live-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--idle);
    transition: background 0.3s, box-shadow 0.3s;
  }
  .sv3-wire-live-toggle input:checked + .sv3-wire-live-dot {
    background: var(--online);
    box-shadow: 0 0 6px var(--online);
  }
  .sv3-wire-clear-btn {
    padding: 0.35rem 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    transition: var(--ease);
  }
  .sv3-wire-clear-btn:hover {
    color: var(--text); border-color: var(--border-hover);
  }
  .sv3-wire-stats {
    font-size: 0.72rem;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-dim);
    padding: 0.25rem 0;
  }

  /* Wire split pane */
  .sv3-wire-split {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 320px);
    min-height: 400px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    background: var(--surface);
  }
  .sv3-wire-list-wrap {
    flex: 1;
    overflow-y: auto;
    overflow-x: auto;
    min-height: 0;
    -webkit-overflow-scrolling: touch;
  }
  .sv3-wire-resize {
    height: 5px;
    background: var(--border);
    cursor: row-resize;
    flex-shrink: 0;
    transition: background 0.2s;
  }
  .sv3-wire-resize:hover {
    background: var(--cyan);
  }
  .sv3-wire-detail {
    height: 250px;
    flex-shrink: 0;
    overflow-y: auto;
    background: rgba(0,0,0,0.2);
    -webkit-overflow-scrolling: touch;
  }
  .sv3-wire-detail-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    font-size: 0.85rem;
    font-style: italic;
  }
  .sv3-wire-detail-header {
    padding: 0.6rem 0.75rem;
    background: rgba(6,182,212,0.08);
    border-bottom: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
    color: var(--text);
  }
  .sv3-wire-detail-tabs {
    display: flex;
    gap: 2px;
    padding: 0.3rem 0.5rem;
    border-bottom: 1px solid var(--border);
  }
  .sv3-wire-dtab {
    padding: 0.25rem 0.75rem;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-size: 0.72rem;
    font-family: inherit;
    border-radius: 4px;
    cursor: pointer;
    transition: var(--ease);
  }
  .sv3-wire-dtab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
  .sv3-wire-dtab.active { color: var(--cyan); background: rgba(6,182,212,0.15); }

  .sv3-wire-json {
    margin: 0;
    padding: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    line-height: 1.5;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-all;
    overflow-y: auto;
    max-height: 300px;
  }

  /* Wire table */
  .sv3-wire-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
  }
  .sv3-wire-table thead {
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
  }
  .sv3-wire-table th {
    padding: 0.45rem 0.5rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    font-size: 0.62rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .sv3-wire-th-id { width: 50px; }
  .sv3-wire-th-time { width: 80px; }
  .sv3-wire-th-arrow { width: 20px; text-align: center; }
  .sv3-wire-table td {
    padding: 0.3rem 0.5rem;
    color: var(--text-muted);
    border-bottom: 1px solid rgba(255,255,255,0.02);
    white-space: nowrap;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .sv3-wire-table tbody tr {
    cursor: pointer;
    transition: background 0.1s;
  }
  .sv3-wire-table tbody tr:hover {
    background: rgba(255,255,255,0.03);
  }
  .sv3-wire-table tbody tr.selected {
    background: rgba(6,182,212,0.12);
    border-left: 3px solid var(--cyan);
  }
  .sv3-wire-table tbody tr.selected td { color: var(--text); }

  /* Wire row type colors */
  .sv3-wire-table tr[data-type="work_request"] td:nth-child(5) { color: #8b5cf6; }
  .sv3-wire-table tr[data-type="register"] td:nth-child(5) { color: #06b6d4; }
  .sv3-wire-table tr[data-type="complete"] td:nth-child(5) { color: #22c55e; }
  .sv3-wire-table tr[data-type="queue"] td:nth-child(5) { color: #f59e0b; }
  .sv3-wire-table tr[data-type="control"] td:nth-child(5) { color: #db2777; }
  .sv3-wire-table tr[data-type="status_query"] td:nth-child(5),
  .sv3-wire-table tr[data-type="events_query"] td:nth-child(5),
  .sv3-wire-table tr[data-type="metrics_query"] td:nth-child(5),
  .sv3-wire-table tr[data-type="health_check"] td:nth-child(5) { color: #64748b; }

  /* Latency badges */
  .sv3-wire-latency { padding: 1px 5px; border-radius: 3px; font-size: 0.68rem; }
  .sv3-wire-latency.fast { background: rgba(34,197,94,0.15); color: #22c55e; }
  .sv3-wire-latency.medium { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .sv3-wire-latency.slow { background: rgba(239,68,68,0.15); color: #ef4444; }

  /* JSON syntax highlighting */
  .sv3-json-key { color: #06b6d4; }
  .sv3-json-string { color: #22c55e; }
  .sv3-json-number { color: #f59e0b; }
  .sv3-json-bool { color: #db2777; }
  .sv3-json-null { color: #64748b; }

  /* ===== Replay Controls ===== */
  .sv3-replay-mode-btn {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-muted);
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    transition: var(--ease);
    flex-shrink: 0;
  }
  .sv3-replay-mode-btn:hover {
    border-color: var(--border-hover);
    color: var(--text);
  }
  .sv3-replay-mode-btn.active {
    border-color: var(--amber);
    color: var(--amber);
    background: rgba(245,158,11,0.1);
  }

  .sv3-replay-controls {
    background: rgba(3, 7, 18, 0.95);
    border-bottom: 1px solid var(--border);
    padding: 0.5rem 1rem;
  }
  .sv3-replay-bar {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    margin-bottom: 0.4rem;
  }
  .sv3-replay-btn {
    padding: 0.3rem 0.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-muted);
    font-size: 0.72rem;
    font-family: 'JetBrains Mono', monospace;
    cursor: pointer;
    transition: var(--ease);
    min-width: 28px;
    text-align: center;
  }
  .sv3-replay-btn:hover {
    color: var(--text); border-color: var(--border-hover);
  }
  .sv3-replay-speed {
    padding: 0.25rem 0.4rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-muted);
    font-size: 0.72rem;
    font-family: 'JetBrains Mono', monospace;
    margin-left: 0.5rem;
  }
  .sv3-replay-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem;
    color: var(--amber);
    margin-left: auto;
    font-weight: 600;
  }
  .sv3-replay-scrubber-wrap {
    position: relative;
    height: 40px;
  }
  .sv3-replay-density {
    width: 100%;
    height: 40px;
    display: block;
    border-radius: 4px;
    background: rgba(0,0,0,0.3);
  }
  .sv3-replay-scrubber {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 40px;
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    cursor: pointer;
    outline: none;
    margin: 0;
  }
  .sv3-replay-scrubber::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 3px;
    height: 40px;
    background: var(--cyan);
    cursor: pointer;
    border: none;
    box-shadow: 0 0 8px var(--cyan);
  }
  .sv3-replay-scrubber::-moz-range-thumb {
    width: 3px;
    height: 40px;
    background: var(--cyan);
    cursor: pointer;
    border: none;
    box-shadow: 0 0 8px var(--cyan);
    border-radius: 0;
  }
  .sv3-replay-scrubber::-webkit-slider-runnable-track {
    height: 40px;
    background: transparent;
  }
  .sv3-replay-scrubber::-moz-range-track {
    height: 40px;
    background: transparent;
  }
</style>

<!-- =========================================================================
     SCRIPTS
     ========================================================================= -->
<script is:inline>
(function() {
  'use strict';

  // ---- Constants ----
  const REFRESH_MS = 5000;
  const API = '/api/swarmv3';

  // ---- State ----
  let online = false;
  let chartInstance = null;
  let chartData = [[], [], [], []]; // timestamps, depth, received, blocked
  let refreshTimer = null;

  // Activity feed state
  let lastEventId = 0;
  let activityEntries = [];
  let activityFilter = 'all';
  let activityCollapsed = false;
  let prevStatusSnapshot = null; // for diff-based event detection

  // Build rate chart state
  let buildRateChartInstance = null;
  let buildRateData = [[], [], []]; // timestamps, success/min, fail/min
  let historyCache = null;
  let historyCacheTime = 0;

  // ---- API helpers ----
  async function v3Get(path, params) {
    try {
      const url = new URL(API + path, location.origin);
      if (params) Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString(), { signal: AbortSignal.timeout(5000), headers: { 'Accept': 'application/json' } });
      if (!res.ok) return null;
      return await res.json();
    } catch { return null; }
  }

  async function v3Post(path, body) {
    try {
      const res = await fetch(API + path, {
        method: 'POST',
        signal: AbortSignal.timeout(5000),
        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined,
      });
      if (!res.ok) return null;
      return await res.json();
    } catch { return null; }
  }

  // ---- DOM refs ----
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  // ---- Tab switching ----
  $$('.sv3-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.sv3-tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
      $$('.sv3-tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      tab.setAttribute('aria-selected','true');
      const panel = $('#tab-' + tab.dataset.tab);
      if (panel) panel.classList.add('active');
    });
  });

  // ---- Control buttons ----
  $$('.sv3-ctrl-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const action = btn.dataset.action;
      btn.disabled = true;
      btn.style.opacity = '0.5';
      const result = await v3Post('/control', { action });
      btn.disabled = false;
      btn.style.opacity = '1';
      if (result && result.ok) {
        refresh();
      }
    });
  });

  // ---- Connection status ----
  function setConnection(isOnline) {
    online = isOnline;
    const el = $('#connection-status');
    const banner = $('#offline-banner');
    if (isOnline) {
      el.className = 'sv3-status live';
      el.querySelector('.sv3-status-text').textContent = 'Connected';
      banner.style.display = 'none';
    } else {
      el.className = 'sv3-status offline';
      el.querySelector('.sv3-status-text').textContent = 'Offline';
      banner.style.display = 'flex';
    }
  }

  // ---- Formatters ----
  function fmtDuration(seconds) {
    if (!seconds && seconds !== 0) return '--';
    if (seconds < 60) return seconds.toFixed(0) + 's';
    if (seconds < 3600) return Math.floor(seconds/60) + 'm ' + (Math.floor(seconds)%60) + 's';
    const h = Math.floor(seconds/3600);
    const m = Math.floor((seconds%3600)/60);
    return h + 'h ' + m + 'm';
  }

  function fmtTime(ts) {
    if (!ts) return '--';
    const d = new Date(ts * 1000);
    return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }

  function fmtPercent(v) {
    if (v == null) return '--';
    return v.toFixed(1) + '%';
  }

  function shortPkg(pkg) {
    if (!pkg) return '--';
    // category/name-version -> category/name
    const parts = pkg.split('/');
    if (parts.length === 2) {
      // strip version: remove trailing -N.N.N...
      return parts[0] + '/' + parts[1].replace(/-\d[\d.]*.*$/, '');
    }
    return pkg;
  }

  // ---- Render: Overview ----
  async function renderOverview() {
    const status = await v3Get('/status');
    if (!status) {
      setConnection(false);
      $('#stat-drones').textContent = '--';
      $('#stat-cores').textContent = '--';
      $('#stat-queue').textContent = '--';
      $('#stat-received').textContent = '--';
      $('#stat-blocked').textContent = '--';
      $('#session-panel').style.display = 'none';
      return;
    }
    setConnection(true);

    $('#stat-drones').textContent = (status.nodes_online || 0) + '/' + (status.nodes || 0);
    $('#stat-cores').textContent = status.total_cores || 0;
    $('#stat-queue').textContent = status.queue_depth || 0;
    $('#stat-received').textContent = status.queue_received || 0;
    $('#stat-blocked').textContent = status.queue_blocked || 0;

    // Session
    if (status.session) {
      const s = status.session;
      $('#session-panel').style.display = 'block';
      $('#session-id').textContent = s.id || '';
      $('#session-profile').textContent = s.profile || '--';
      const completed = s.completed || 0;
      const total = s.total_packages || 1;
      const pct = ((completed / total) * 100).toFixed(1);
      $('#session-progress').textContent = completed + ' / ' + total + ' (' + pct + '%)';
      $('#session-progress-fill').style.width = pct + '%';
      $('#session-elapsed').textContent = fmtDuration(s.elapsed);
      $('#session-eta').textContent = s.eta ? fmtDuration(s.eta) : 'calculating...';
    } else {
      $('#session-panel').style.display = 'none';
    }

    // Push chart data point
    const now = Date.now() / 1000;
    chartData[0].push(now);
    chartData[1].push(status.queue_depth || 0);
    chartData[2].push(status.queue_received || 0);
    chartData[3].push(status.queue_blocked || 0);

    // Keep last 120 points (10 minutes at 5s interval)
    if (chartData[0].length > 120) {
      chartData[0] = chartData[0].slice(-120);
      chartData[1] = chartData[1].slice(-120);
      chartData[2] = chartData[2].slice(-120);
      chartData[3] = chartData[3].slice(-120);
    }

    updateChart();
  }

  // ---- Render: Fleet ----
  async function renderFleet() {
    const nodes = await v3Get('/nodes', { all: 'true' });
    const grid = $('#fleet-grid');
    if (!nodes || !Array.isArray(nodes) || nodes.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-dim);padding:3rem;">No fleet data available</div>';
      return;
    }

    grid.innerHTML = nodes.map(n => {
      const statusClass = n.status || 'offline';
      const cpuFill = n.cpu_percent || 0;
      const ramFill = n.ram_percent || 0;
      const cpuWarn = cpuFill > 80 ? (cpuFill > 95 ? 'crit' : 'warn') : '';
      const ramWarn = ramFill > 80 ? (ramFill > 95 ? 'crit' : 'warn') : '';
      const taskText = n.current_task ? shortPkg(n.current_task) : 'Idle';
      const taskClass = n.current_task ? '' : ' idle';
      const cardClass = n.status === 'offline' ? ' offline-card' : '';

      return `
        <div class="sv3-drone-card${cardClass}">
          <div class="sv3-drone-head">
            <div>
              <div class="sv3-drone-name">${esc(n.name || n.id)}</div>
              <div class="sv3-drone-ip">${esc(n.ip || '--')}</div>
            </div>
            <span class="sv3-drone-badge ${statusClass}">
              <span class="sv3-drone-badge-dot"></span>
              ${statusClass}
            </span>
          </div>
          <div class="sv3-drone-metrics">
            <div>
              <div class="sv3-drone-metric-label">CPU</div>
              <div class="sv3-drone-metric-bar"><div class="sv3-drone-metric-fill ${cpuWarn}" style="width:${cpuFill}%"></div></div>
              <div class="sv3-drone-metric-val">${fmtPercent(n.cpu_percent)}</div>
            </div>
            <div>
              <div class="sv3-drone-metric-label">RAM</div>
              <div class="sv3-drone-metric-bar"><div class="sv3-drone-metric-fill ${ramWarn}" style="width:${ramFill}%"></div></div>
              <div class="sv3-drone-metric-val">${fmtPercent(n.ram_percent)}</div>
            </div>
          </div>
          <div class="sv3-drone-task">
            <div class="sv3-drone-task-label">Current Task</div>
            <div class="sv3-drone-task-val${taskClass}">${esc(taskText)}</div>
          </div>
          <div class="sv3-drone-foot">
            <span class="sv3-drone-cores">${n.cores || 0} cores</span>
            <span>${n.builds_completed || 0} built / ${n.builds_failed || 0} failed</span>
          </div>
        </div>
      `;
    }).join('');
  }

  // ---- Render: Queue ----
  async function renderQueue() {
    const status = await v3Get('/status');
    if (!status) return;

    // Breakdown bar - fetch queue entries for accurate counts
    // Use status-level counts as fallback
    const total = (status.queue_depth || 0) + (status.queue_received || 0) + (status.queue_blocked || 0);
    const needed = status.queue_depth || 0;
    const received = status.queue_received || 0;
    const blocked = status.queue_blocked || 0;
    // delegated count comes from nodes actively building
    const delegated = 0; // Will be refined when we have queue detail

    if (total > 0) {
      const pctN = ((needed/total)*100).toFixed(1);
      const pctD = ((delegated/total)*100).toFixed(1);
      const pctR = ((received/total)*100).toFixed(1);
      const pctB = ((blocked/total)*100).toFixed(1);
      $('#seg-needed').style.width = pctN + '%';
      $('#seg-delegated').style.width = pctD + '%';
      $('#seg-received').style.width = pctR + '%';
      $('#seg-blocked').style.width = pctB + '%';
    }
    $('#legend-needed').textContent = needed;
    $('#legend-delegated').textContent = delegated;
    $('#legend-received').textContent = received;
    $('#legend-blocked').textContent = blocked;

    // Fetch detailed queue - try /queue endpoint, fall back to history
    const queueData = await v3Get('/queue');
    const tbody = $('#queue-tbody');

    if (queueData && Array.isArray(queueData) && queueData.length > 0) {
      tbody.innerHTML = queueData.map(q => {
        const st = q.status || 'needed';
        return `<tr>
          <td>${esc(shortPkg(q.package))}</td>
          <td><span class="sv3-status-pill ${st}">${st}</span></td>
          <td>${esc(q.assigned_to || '--')}</td>
          <td>${q.failures || 0}</td>
        </tr>`;
      }).join('');
    } else if (queueData && queueData.packages) {
      // Alternative response shape
      const pkgs = queueData.packages;
      tbody.innerHTML = pkgs.map(q => {
        const st = q.status || 'needed';
        return `<tr>
          <td>${esc(shortPkg(q.package || q.name))}</td>
          <td><span class="sv3-status-pill ${st}">${st}</span></td>
          <td>${esc(q.assigned_to || q.drone || '--')}</td>
          <td>${q.failures || 0}</td>
        </tr>`;
      }).join('');
    } else {
      tbody.innerHTML = '<tr class="sv3-empty-row"><td colspan="4">No queue data</td></tr>';
    }
  }

  // ---- Render: History ----
  async function renderHistory() {
    const data = await v3Get('/history', { limit: '100' });
    const tbody = $('#history-tbody');

    if (!data) {
      tbody.innerHTML = '<tr class="sv3-empty-row"><td colspan="5">No history data</td></tr>';
      return;
    }

    // Stats
    if (data.stats) {
      const s = data.stats;
      $('#hist-avg-time').textContent = fmtDuration(s.avg_duration_s);
      $('#hist-success-rate').textContent = s.success_rate != null ? s.success_rate.toFixed(1) + '%' : '--';
      $('#hist-total').textContent = s.total_builds || 0;
    }

    // Table
    const entries = data.history || [];
    if (entries.length === 0) {
      tbody.innerHTML = '<tr class="sv3-empty-row"><td colspan="5">No history entries yet</td></tr>';
      return;
    }

    tbody.innerHTML = entries.map(e => {
      const st = e.status || 'success';
      return `<tr>
        <td>${esc(shortPkg(e.package))}</td>
        <td>${esc(e.drone_name || '--')}</td>
        <td><span class="sv3-status-pill ${st}">${st}</span></td>
        <td>${fmtDuration(e.duration_seconds)}</td>
        <td>${fmtTime(e.built_at)}</td>
      </tr>`;
    }).join('');
  }

  // ---- Escape HTML ----
  function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // ---- uPlot Chart ----
  let uPlotLoaded = false;

  function loadUPlot() {
    return new Promise((resolve, reject) => {
      if (uPlotLoaded && window.uPlot) { resolve(); return; }

      // Load CSS
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/uplot@1.6.30/dist/uPlot.min.css';
      document.head.appendChild(link);

      // Load JS
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/uplot@1.6.30/dist/uPlot.iife.min.js';
      script.onload = () => { uPlotLoaded = true; resolve(); };
      script.onerror = () => reject(new Error('Failed to load uPlot'));
      document.head.appendChild(script);
    });
  }

  async function updateChart() {
    if (chartData[0].length < 2) {
      $('#queue-chart').textContent = 'Collecting data points...';
      return;
    }

    try {
      await loadUPlot();
    } catch {
      $('#queue-chart').textContent = 'Chart unavailable (CDN unreachable)';
      return;
    }

    const container = $('#queue-chart');

    const opts = {
      width: container.clientWidth - 16,
      height: 240,
      cursor: { show: true },
      scales: {
        x: { time: true },
        y: { min: 0 },
      },
      axes: [
        {
          stroke: '#64748b',
          grid: { stroke: 'rgba(255,255,255,0.04)', width: 1 },
          ticks: { stroke: 'rgba(255,255,255,0.06)', width: 1 },
          font: '10px JetBrains Mono, monospace',
        },
        {
          stroke: '#64748b',
          grid: { stroke: 'rgba(255,255,255,0.04)', width: 1 },
          ticks: { stroke: 'rgba(255,255,255,0.06)', width: 1 },
          font: '10px JetBrains Mono, monospace',
          size: 50,
        },
      ],
      series: [
        {},
        {
          label: 'Queue',
          stroke: '#06b6d4',
          width: 2,
          fill: 'rgba(6, 182, 212, 0.1)',
        },
        {
          label: 'Received',
          stroke: '#22c55e',
          width: 2,
          fill: 'rgba(34, 197, 94, 0.08)',
        },
        {
          label: 'Blocked',
          stroke: '#f59e0b',
          width: 2,
          fill: 'rgba(245, 158, 11, 0.08)',
        },
      ],
    };

    if (chartInstance) {
      chartInstance.setData(chartData);
      // Resize if container changed
      const w = container.clientWidth - 16;
      if (Math.abs(chartInstance.width - w) > 20) {
        chartInstance.setSize({ width: w, height: 240 });
      }
    } else {
      container.textContent = '';
      chartInstance = new window.uPlot(opts, chartData, container);
    }
  }

  // Handle window resize
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (chartInstance) {
        const container = $('#queue-chart');
        chartInstance.setSize({ width: container.clientWidth - 16, height: 240 });
      }
      if (buildRateChartInstance) {
        const container2 = $('#build-rate-chart');
        buildRateChartInstance.setSize({ width: container2.clientWidth - 16, height: 240 });
      }
    }, 200);
  });

  // ---- Activity Feed ----
  function initActivityPanel() {
    const header = $('#activity-header');
    const panel = $('#activity-panel');
    const toggle = $('#activity-toggle');

    if (header) {
      header.addEventListener('click', function(e) {
        // Don't toggle if clicking filter buttons
        if (e.target.closest('.sv3-af-filter')) return;
        activityCollapsed = !activityCollapsed;
        panel.classList.toggle('collapsed', activityCollapsed);
        if (toggle) toggle.textContent = activityCollapsed ? '+' : '...';
      });
    }

    $$('.sv3-af-filter').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        $$('.sv3-af-filter').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        activityFilter = btn.dataset.filter || 'all';
        applyActivityFilter();
      });
    });
  }

  function getActivityCategory(type) {
    if (['assign', 'queue', 'complete', 'delegate'].indexOf(type) !== -1) return 'builds';
    if (['fail', 'grounded', 'error'].indexOf(type) !== -1) return 'errors';
    if (['register', 'control', 'rebalance', 'reclaim'].indexOf(type) !== -1) return 'system';
    return 'system';
  }

  function applyActivityFilter() {
    var entries = $$('#activity-entries .sv3-activity-entry');
    entries.forEach(function(el) {
      if (activityFilter === 'all') {
        el.classList.remove('hidden');
      } else {
        var type = el.getAttribute('data-type') || '';
        var cat = getActivityCategory(type);
        el.classList.toggle('hidden', cat !== activityFilter);
      }
    });
  }

  function addActivityEntry(evt) {
    activityEntries.push(evt);
    var container = $('#activity-entries');
    if (!container) return;

    var el = document.createElement('div');
    el.className = 'sv3-activity-entry';
    el.setAttribute('data-type', evt.type || 'system');

    var ts = evt.timestamp ? new Date(evt.timestamp * 1000) : new Date();
    var timeStr = ts.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });

    el.innerHTML = '<span class="sv3-ae-time">' + esc(timeStr) + '</span>' +
      '<span class="sv3-ae-badge">' + esc(evt.type || 'info') + '</span>' +
      '<span class="sv3-ae-msg">' + esc(evt.message || '') + '</span>';

    // Apply current filter
    var cat = getActivityCategory(evt.type || 'system');
    if (activityFilter !== 'all' && cat !== activityFilter) {
      el.classList.add('hidden');
    }

    container.appendChild(el);

    // Update count
    var countEl = $('#activity-count');
    if (countEl) countEl.textContent = activityEntries.length;

    // Auto-scroll to bottom
    var body = $('#activity-body');
    if (body) body.scrollTop = body.scrollHeight;
  }

  async function pollActivityFeed() {
    // Try the events endpoint first
    var data = await v3Get('/events', { since: String(lastEventId) });
    if (data && data.events && Array.isArray(data.events)) {
      data.events.forEach(function(evt) {
        addActivityEntry(evt);
      });
      if (data.latest_id != null) lastEventId = data.latest_id;
      return;
    }

    // Fallback: diff-based event detection from status
    var status = await v3Get('/status');
    if (!status) return;

    var snap = {
      queue_depth: status.queue_depth || 0,
      queue_received: status.queue_received || 0,
      queue_blocked: status.queue_blocked || 0,
      nodes_online: status.nodes_online || 0
    };

    if (prevStatusSnapshot) {
      var prev = prevStatusSnapshot;
      if (snap.queue_received > prev.queue_received) {
        var diff = snap.queue_received - prev.queue_received;
        addActivityEntry({ type: 'complete', message: diff + ' build(s) completed', timestamp: Date.now()/1000 });
      }
      if (snap.queue_blocked > prev.queue_blocked) {
        var diff = snap.queue_blocked - prev.queue_blocked;
        addActivityEntry({ type: 'fail', message: diff + ' package(s) blocked', timestamp: Date.now()/1000 });
      }
      if (snap.queue_depth !== prev.queue_depth && snap.queue_depth > prev.queue_depth) {
        var diff = snap.queue_depth - prev.queue_depth;
        addActivityEntry({ type: 'queue', message: diff + ' package(s) added to queue', timestamp: Date.now()/1000 });
      }
      if (snap.nodes_online !== prev.nodes_online) {
        if (snap.nodes_online > prev.nodes_online) {
          addActivityEntry({ type: 'register', message: 'Drone came online (' + snap.nodes_online + ' total)', timestamp: Date.now()/1000 });
        } else {
          addActivityEntry({ type: 'grounded', message: 'Drone went offline (' + snap.nodes_online + ' remaining)', timestamp: Date.now()/1000 });
        }
      }
    }
    prevStatusSnapshot = snap;
  }

  // ---- Build Rate Chart ----
  async function fetchHistoryForCharts() {
    // Cache for 30s
    var now = Date.now();
    if (historyCache && (now - historyCacheTime) < 30000) return historyCache;

    var data = await v3Get('/history', { limit: '500' });
    if (data) {
      historyCache = data;
      historyCacheTime = now;
    }
    return data;
  }

  async function updateBuildRateChart() {
    var data = await fetchHistoryForCharts();
    if (!data || !data.history || data.history.length < 2) {
      $('#build-rate-chart').textContent = 'Waiting for history data...';
      return;
    }

    // Bucket by minute
    var buckets = {};
    data.history.forEach(function(e) {
      if (!e.built_at) return;
      var minuteKey = Math.floor(e.built_at / 60) * 60;
      if (!buckets[minuteKey]) buckets[minuteKey] = { ok: 0, fail: 0 };
      if (e.status === 'failed') {
        buckets[minuteKey].fail++;
      } else {
        buckets[minuteKey].ok++;
      }
    });

    var keys = Object.keys(buckets).map(Number).sort();
    if (keys.length < 2) {
      $('#build-rate-chart').textContent = 'Not enough data points yet...';
      return;
    }

    buildRateData[0] = keys;
    buildRateData[1] = keys.map(function(k) { return buckets[k].ok; });
    buildRateData[2] = keys.map(function(k) { return buckets[k].fail; });

    try {
      await loadUPlot();
    } catch(err) {
      $('#build-rate-chart').textContent = 'Chart unavailable';
      return;
    }

    var container = $('#build-rate-chart');
    var opts = {
      width: container.clientWidth - 16,
      height: 240,
      cursor: { show: true },
      scales: {
        x: { time: true },
        y: { min: 0 },
      },
      axes: [
        {
          stroke: '#64748b',
          grid: { stroke: 'rgba(255,255,255,0.04)', width: 1 },
          ticks: { stroke: 'rgba(255,255,255,0.06)', width: 1 },
          font: '10px JetBrains Mono, monospace',
        },
        {
          stroke: '#64748b',
          grid: { stroke: 'rgba(255,255,255,0.04)', width: 1 },
          ticks: { stroke: 'rgba(255,255,255,0.06)', width: 1 },
          font: '10px JetBrains Mono, monospace',
          size: 50,
        },
      ],
      series: [
        {},
        {
          label: 'Success/min',
          stroke: '#22c55e',
          width: 2,
          fill: 'rgba(34, 197, 94, 0.15)',
          paths: function(u, seriesIdx, idx0, idx1) {
            return uPlot.paths.stepped({ align: 1 })(u, seriesIdx, idx0, idx1);
          },
        },
        {
          label: 'Failed/min',
          stroke: '#ef4444',
          width: 2,
          fill: 'rgba(239, 68, 68, 0.12)',
          paths: function(u, seriesIdx, idx0, idx1) {
            return uPlot.paths.stepped({ align: 1 })(u, seriesIdx, idx0, idx1);
          },
        },
      ],
    };

    if (buildRateChartInstance) {
      buildRateChartInstance.setData(buildRateData);
      var w = container.clientWidth - 16;
      if (Math.abs(buildRateChartInstance.width - w) > 20) {
        buildRateChartInstance.setSize({ width: w, height: 240 });
      }
    } else {
      container.textContent = '';
      buildRateChartInstance = new window.uPlot(opts, buildRateData, container);
    }
  }

  // ---- CPU Gauge ----
  function updateCPUGauge(nodes) {
    var arc = $('#cpu-gauge-arc');
    var valEl = $('#cpu-gauge-val');
    if (!arc || !valEl) return;

    if (!nodes || !Array.isArray(nodes) || nodes.length === 0) {
      arc.setAttribute('stroke-dasharray', '0 251');
      valEl.textContent = '--%';
      return;
    }

    var onlineNodes = nodes.filter(function(n) { return n.status === 'online'; });
    if (onlineNodes.length === 0) {
      arc.setAttribute('stroke-dasharray', '0 251');
      valEl.textContent = '--%';
      return;
    }

    var totalCpu = 0;
    onlineNodes.forEach(function(n) { totalCpu += (n.cpu_percent || 0); });
    var avgCpu = totalCpu / onlineNodes.length;

    var dashLen = (avgCpu / 100) * 251;
    arc.setAttribute('stroke-dasharray', dashLen.toFixed(1) + ' 251');

    // Color based on utilization
    var color = '#06b6d4';
    if (avgCpu > 80) color = '#ef4444';
    else if (avgCpu > 60) color = '#f59e0b';
    arc.setAttribute('stroke', color);

    valEl.textContent = avgCpu.toFixed(1) + '%';
  }

  // ---- Duration Histogram ----
  async function renderDurationHistogram() {
    var data = await fetchHistoryForCharts();
    var container = $('#duration-histogram');
    if (!container) return;

    if (!data || !data.history || data.history.length === 0) {
      container.innerHTML = '<div class="sv3-dp-empty">No history data for histogram</div>';
      return;
    }

    var buckets = [
      { label: '0-30s', min: 0, max: 30, count: 0, color: '#22c55e' },
      { label: '30-60s', min: 30, max: 60, count: 0, color: '#4ade80' },
      { label: '1-2m', min: 60, max: 120, count: 0, color: '#84cc16' },
      { label: '2-5m', min: 120, max: 300, count: 0, color: '#eab308' },
      { label: '5-10m', min: 300, max: 600, count: 0, color: '#f59e0b' },
      { label: '10m+', min: 600, max: Infinity, count: 0, color: '#ef4444' },
    ];

    data.history.forEach(function(e) {
      if (e.duration_seconds == null) return;
      for (var i = 0; i < buckets.length; i++) {
        if (e.duration_seconds >= buckets[i].min && e.duration_seconds < buckets[i].max) {
          buckets[i].count++;
          break;
        }
      }
    });

    var maxCount = Math.max.apply(null, buckets.map(function(b) { return b.count; }));
    if (maxCount === 0) maxCount = 1;

    container.innerHTML = buckets.map(function(b) {
      var pct = ((b.count / maxCount) * 100).toFixed(1);
      return '<div class="sv3-histo-row">' +
        '<span class="sv3-histo-label">' + b.label + '</span>' +
        '<div class="sv3-histo-bar-wrap"><div class="sv3-histo-bar" style="width:' + pct + '%;background:' + b.color + ';"></div></div>' +
        '<span class="sv3-histo-count">' + b.count + '</span>' +
        '</div>';
    }).join('');
  }

  // ---- Drone Performance ----
  async function renderDronePerformance() {
    var data = await fetchHistoryForCharts();
    var container = $('#drone-perf');
    if (!container) return;

    // Try to use stats.per_drone from API response
    if (data && data.stats && data.stats.per_drone && data.stats.per_drone.length > 0) {
      var drones = data.stats.per_drone;
      container.innerHTML = drones.map(function(d) {
        var rate = d.total > 0 ? ((d.success / d.total) * 100) : 0;
        return '<div class="sv3-dp-row">' +
          '<span class="sv3-dp-name">' + esc(d.drone_name) + '</span>' +
          '<div class="sv3-dp-bar-wrap"><div class="sv3-dp-bar-fill" style="width:' + rate.toFixed(1) + '%"></div>' +
          '<span class="sv3-dp-bar-label">' + rate.toFixed(0) + '%</span></div>' +
          '<span class="sv3-dp-builds">' + (d.total || 0) + '</span>' +
          '<span class="sv3-dp-avg">' + fmtDuration(d.avg_duration) + '</span>' +
          '</div>';
      }).join('');
      return;
    }

    // Fallback: aggregate from entries
    if (!data || !data.history || data.history.length === 0) {
      container.innerHTML = '<div class="sv3-dp-empty">No per-drone data available</div>';
      return;
    }

    var droneStats = {};
    data.history.forEach(function(e) {
      var name = e.drone_name || 'unknown';
      if (!droneStats[name]) droneStats[name] = { total: 0, success: 0, durSum: 0 };
      droneStats[name].total++;
      if (e.status !== 'failed') droneStats[name].success++;
      if (e.duration_seconds) droneStats[name].durSum += e.duration_seconds;
    });

    var dKeys = Object.keys(droneStats);
    if (dKeys.length === 0) {
      container.innerHTML = '<div class="sv3-dp-empty">No per-drone data available</div>';
      return;
    }

    container.innerHTML = dKeys.map(function(name) {
      var d = droneStats[name];
      var rate = d.total > 0 ? ((d.success / d.total) * 100) : 0;
      var avgDur = d.total > 0 ? (d.durSum / d.total) : 0;
      return '<div class="sv3-dp-row">' +
        '<span class="sv3-dp-name">' + esc(name) + '</span>' +
        '<div class="sv3-dp-bar-wrap"><div class="sv3-dp-bar-fill" style="width:' + rate.toFixed(1) + '%"></div>' +
        '<span class="sv3-dp-bar-label">' + rate.toFixed(0) + '%</span></div>' +
        '<span class="sv3-dp-builds">' + d.total + '</span>' +
        '<span class="sv3-dp-avg">' + fmtDuration(avgDur) + '</span>' +
        '</div>';
    }).join('');
  }

  // ---- Architecture Stepper ----
  (function initArchStepper() {
    var steps = $$('.sv3-arch-step');
    steps.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var ver = btn.dataset.arch;
        // Update stepper active state
        steps.forEach(function(s) { s.classList.remove('active'); });
        btn.classList.add('active');
        // Switch diagram
        $$('.sv3-arch-diagram').forEach(function(d) { d.classList.remove('active'); });
        var target = $('#arch-' + ver);
        if (target) target.classList.add('active');
        // Switch "What Changed" cards
        $$('.sv3-arch-change-card').forEach(function(c) {
          if (c.dataset.for === ver) {
            c.classList.add('visible');
          } else {
            c.classList.remove('visible');
          }
        });
      });
    });
    // Init: show v3 cards
    $$('.sv3-arch-change-card').forEach(function(c) {
      if (c.dataset.for === 'v3') c.classList.add('visible');
    });
  })();

  // ---- Topology Tab ----
  var topoAnimFrame = null;
  var topoPackets = [];
  var topoPaths = [];
  var topoPrevDroneMap = {};
  var topoStartTime = Date.now();

  function renderTopology(nodes) {
    var svg = $('#sv3-topo-svg');
    if (!svg) return;
    var connLayer = $('#sv3-topo-connections');
    var nodesLayer = $('#sv3-topo-nodes');
    if (!connLayer || !nodesLayer) return;

    if (!nodes || !Array.isArray(nodes) || nodes.length === 0) {
      connLayer.innerHTML = '';
      nodesLayer.innerHTML = '<text x="600" y="300" text-anchor="middle" fill="#64748b" font-size="14">No fleet data available</text>';
      topoPaths = [];
      return;
    }

    var cpX = 600, cpY = 80;
    var onlineNodes = nodes.filter(function(n) { return n.status !== 'offline'; });
    var droneCount = nodes.length;
    var NS = 'http://www.w3.org/2000/svg';

    // Calculate semicircle positions
    var positions = [];
    var arcStart = Math.PI * 0.15;
    var arcEnd = Math.PI * 0.85;
    var radius = 220;
    for (var i = 0; i < droneCount; i++) {
      var angle = droneCount === 1 ? Math.PI * 0.5 : arcStart + (arcEnd - arcStart) * (i / (droneCount - 1));
      var dx = cpX + Math.cos(angle) * radius * 1.8 - radius * 0.8;
      var dy = cpY + 120 + Math.sin(angle) * radius;
      positions.push({ x: dx, y: dy });
    }

    // Build connections
    var pathsHTML = '';
    topoPaths = [];
    for (var i = 0; i < droneCount; i++) {
      var p = positions[i];
      var midX = (cpX + p.x) / 2;
      var midY = (cpY + 30 + p.y) / 2 - 30;
      var pathD = 'M ' + cpX + ',' + (cpY + 30) + ' Q ' + midX + ',' + midY + ' ' + p.x + ',' + p.y;
      var statusColor = nodes[i].status === 'online' ? 'rgba(6,182,212,0.3)' : 'rgba(100,116,139,0.15)';
      pathsHTML += '<path d="' + pathD + '" stroke="' + statusColor + '" stroke-width="1.5" fill="none" id="topo-path-' + i + '" data-drone="' + esc(nodes[i].name || nodes[i].id) + '" style="cursor:pointer;"/>';
      topoPaths.push({ d: pathD, nodeIdx: i });
    }
    connLayer.innerHTML = pathsHTML;

    // Add click handlers to connection paths for cross-tab navigation
    connLayer.querySelectorAll('path[data-drone]').forEach(function(p) {
      p.addEventListener('click', function() {
        var droneName = p.getAttribute('data-drone');
        if (droneName) navigateToWireForDrone(droneName);
      });
    });

    // Build nodes
    var nodesHTML = '';
    // Control Plane node
    nodesHTML += '<g transform="translate(' + cpX + ',' + cpY + ')">';
    nodesHTML += '<rect x="-70" y="-25" width="140" height="55" rx="10" fill="#0f172a" stroke="#06b6d4" stroke-width="2" filter="url(#topo-node-glow)"/>';
    nodesHTML += '<text x="0" y="-2" text-anchor="middle" class="sv3-topo-node-label" fill="#06b6d4" font-size="13" font-weight="700">Control Plane</text>';
    nodesHTML += '<text x="0" y="17" text-anchor="middle" class="sv3-topo-node-sub">SQLite + REST API</text>';
    nodesHTML += '</g>';

    // Drone nodes
    for (var i = 0; i < droneCount; i++) {
      var n = nodes[i];
      var p = positions[i];
      var statusFill = n.status === 'online' ? '#22c55e' : (n.status === 'draining' ? '#f59e0b' : '#ef4444');
      var cpuPct = n.cpu_percent || 0;
      var ramPct = n.ram_percent || 0;
      var cpuW = Math.max(1, (cpuPct / 100) * 100);
      var ramW = Math.max(1, (ramPct / 100) * 100);
      var taskLabel = n.current_task ? shortPkg(n.current_task) : '';

      nodesHTML += '<g transform="translate(' + p.x + ',' + p.y + ')">';
      nodesHTML += '<rect x="-60" y="-30" width="120" height="' + (taskLabel ? '80' : '65') + '" rx="8" fill="#0f172a" stroke="' + (n.status === 'online' ? 'rgba(6,182,212,0.5)' : 'rgba(100,116,139,0.3)') + '" stroke-width="1.5"/>';
      // Status dot
      nodesHTML += '<circle cx="-45" cy="-15" r="4" fill="' + statusFill + '"/>';
      // Name
      nodesHTML += '<text x="-35" y="-11" class="sv3-topo-node-label" font-size="11">' + esc(n.name || n.id) + '</text>';
      // IP
      nodesHTML += '<text x="-45" y="5" class="sv3-topo-node-sub">' + esc(n.ip || '') + '</text>';
      // CPU bar
      nodesHTML += '<rect x="-45" y="14" width="100" height="4" rx="2" fill="rgba(255,255,255,0.08)"/>';
      nodesHTML += '<rect x="-45" y="14" width="' + cpuW + '" height="4" rx="2" fill="' + (cpuPct > 80 ? '#ef4444' : '#06b6d4') + '" class="sv3-topo-cpu-bar"/>';
      nodesHTML += '<text x="58" y="18" text-anchor="end" font-size="7" fill="#64748b" font-family="monospace">CPU</text>';
      // RAM bar
      nodesHTML += '<rect x="-45" y="22" width="100" height="4" rx="2" fill="rgba(255,255,255,0.08)"/>';
      nodesHTML += '<rect x="-45" y="22" width="' + ramW + '" height="4" rx="2" fill="' + (ramPct > 80 ? '#f59e0b' : '#22c55e') + '"/>';
      nodesHTML += '<text x="58" y="26" text-anchor="end" font-size="7" fill="#64748b" font-family="monospace">RAM</text>';
      // Task label
      if (taskLabel) {
        nodesHTML += '<text x="0" y="42" text-anchor="middle" class="sv3-topo-node-pkg">' + esc(taskLabel) + '</text>';
      }
      nodesHTML += '</g>';
    }
    nodesLayer.innerHTML = nodesHTML;

    // Detect assignment changes and create packet animations
    var newDroneMap = {};
    nodes.forEach(function(n, i) {
      newDroneMap[n.name || n.id] = { task: n.current_task || null, idx: i };
    });

    Object.keys(newDroneMap).forEach(function(name) {
      var curr = newDroneMap[name];
      var prev = topoPrevDroneMap[name];
      if (curr.task && (!prev || prev.task !== curr.task)) {
        // New assignment: send purple packet CP -> drone
        createTopoPacket(curr.idx, 'request');
      }
      if (prev && prev.task && !curr.task) {
        // Completion: send green packet drone -> CP
        createTopoPacket(prev.idx, 'complete');
      }
    });
    topoPrevDroneMap = newDroneMap;
  }

  function createTopoPacket(droneIdx, type, label) {
    if (droneIdx < 0 || droneIdx >= topoPaths.length) return;
    var pathEl = document.getElementById('topo-path-' + droneIdx);
    if (!pathEl) return;
    topoPackets.push({
      pathEl: pathEl,
      progress: (type === 'complete' || type === 'heartbeat') ? 1 : 0,
      speed: type === 'heartbeat' ? 0.025 : (0.015 + Math.random() * 0.008),
      direction: (type === 'complete' || type === 'heartbeat') ? -1 : 1,
      type: type,
      label: label || '',
      id: Math.random()
    });
  }

  function animateTopoPackets() {
    var layer = $('#sv3-topo-packets');
    if (!layer) { topoAnimFrame = requestAnimationFrame(animateTopoPackets); return; }

    // Check if topology tab is active
    var activeTab = document.querySelector('.sv3-tab.active');
    if (!activeTab || activeTab.dataset.tab !== 'topology') {
      topoAnimFrame = requestAnimationFrame(animateTopoPackets);
      return;
    }

    layer.innerHTML = '';
    topoPackets = topoPackets.filter(function(pkt) {
      pkt.progress += pkt.speed * pkt.direction;
      if (pkt.progress > 1 || pkt.progress < 0) return false;
      try {
        var len = pkt.pathEl.getTotalLength();
        var pt = pkt.pathEl.getPointAtLength(len * pkt.progress);
        var color, glowId, r;
        if (pkt.type === 'complete') {
          color = '#22c55e'; glowId = 'topo-glow-green'; r = 5;
        } else if (pkt.type === 'heartbeat') {
          color = '#06b6d4'; glowId = 'topo-glow-cyan'; r = 3;
        } else {
          color = '#8b5cf6'; glowId = 'topo-glow-purple'; r = 5;
        }
        var NS = 'http://www.w3.org/2000/svg';
        var g = document.createElementNS(NS, 'g');
        var circle = document.createElementNS(NS, 'circle');
        circle.setAttribute('cx', pt.x);
        circle.setAttribute('cy', pt.y);
        circle.setAttribute('r', String(r));
        circle.setAttribute('fill', color);
        circle.setAttribute('filter', 'url(#' + glowId + ')');
        g.appendChild(circle);
        // Tooltip
        if (pkt.label) {
          var title = document.createElementNS(NS, 'title');
          title.textContent = pkt.label;
          g.appendChild(title);
        }
        layer.appendChild(g);
      } catch(e) { return false; }
      return true;
    });

    // Ambient packets only when no protocol data is driving them
    if (topoLastProtoId === 0 && Math.random() < 0.01 && topoPaths.length > 0) {
      var randIdx = Math.floor(Math.random() * topoPaths.length);
      createTopoPacket(randIdx, Math.random() > 0.5 ? 'request' : 'complete');
    }

    topoAnimFrame = requestAnimationFrame(animateTopoPackets);
  }

  function updateTopoSidebar(status, nodes) {
    var coresEl = $('#topo-cores');
    var throughputEl = $('#topo-throughput');
    var activeEl = $('#topo-active');
    var uptimeEl = $('#topo-uptime');

    if (status) {
      if (coresEl) coresEl.textContent = status.total_cores || '--';
      if (throughputEl) throughputEl.textContent = (status.queue_received || 0) + '/' + ((status.queue_depth || 0) + (status.queue_received || 0));
      if (activeEl) {
        var building = 0;
        if (nodes && Array.isArray(nodes)) {
          nodes.forEach(function(n) { if (n.current_task) building++; });
        }
        activeEl.textContent = building;
      }
      if (uptimeEl) {
        var elapsed = Math.floor((Date.now() - topoStartTime) / 1000);
        uptimeEl.textContent = fmtDuration(elapsed);
      }
    }
  }

  // Start topology animation loop
  topoAnimFrame = requestAnimationFrame(animateTopoPackets);

  // ---- Wire Tab ----
  var wireEntries = [];
  var wireLastId = 0;
  var wireLive = true;
  var wireSelectedId = null;
  var wireDetailTab = 'request';
  var wireAtBottom = true;
  var wireFilterDebounce = null;
  var wireObservedDrones = new Set();

  function initWireTab() {
    // Filter change handlers
    var typeF = $('#wire-filter-type');
    var droneF = $('#wire-filter-drone');
    var pkgF = $('#wire-filter-package');
    var latF = $('#wire-filter-latency');
    var liveF = $('#wire-live');
    var clearBtn = $('#wire-clear-filters');

    if (typeF) typeF.addEventListener('change', function() { wireLastId = 0; wireEntries = []; pollWire(); });
    if (droneF) droneF.addEventListener('change', function() { wireLastId = 0; wireEntries = []; pollWire(); });
    if (latF) latF.addEventListener('change', function() { wireLastId = 0; wireEntries = []; pollWire(); });
    if (pkgF) pkgF.addEventListener('input', function() {
      clearTimeout(wireFilterDebounce);
      wireFilterDebounce = setTimeout(function() { wireLastId = 0; wireEntries = []; pollWire(); }, 300);
    });
    if (liveF) liveF.addEventListener('change', function() { wireLive = liveF.checked; });
    if (clearBtn) clearBtn.addEventListener('click', function() {
      if (typeF) typeF.value = '';
      if (droneF) droneF.value = '';
      if (pkgF) pkgF.value = '';
      if (latF) latF.value = '';
      wireLastId = 0; wireEntries = []; pollWire();
    });

    // Detail tab switching
    $$('.sv3-wire-dtab').forEach(function(btn) {
      btn.addEventListener('click', function() {
        $$('.sv3-wire-dtab').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        wireDetailTab = btn.dataset.dtab;
        if (wireSelectedId) showWireDetail(wireSelectedId, wireDetailTab);
      });
    });

    // Auto-scroll detection
    var listWrap = $('#wire-list-wrap');
    if (listWrap) {
      listWrap.addEventListener('scroll', function() {
        wireAtBottom = (listWrap.scrollTop + listWrap.clientHeight >= listWrap.scrollHeight - 20);
      });
    }

    // Resize handle
    initWireResize();
  }

  async function pollWire() {
    if (replayMode) return;  // Don't poll in replay mode
    var params = { since: String(wireLastId), limit: '200' };
    var typeF = $('#wire-filter-type');
    var droneF = $('#wire-filter-drone');
    var pkgF = $('#wire-filter-package');
    var latF = $('#wire-filter-latency');
    if (typeF && typeF.value) params.type = typeF.value;
    if (droneF && droneF.value) params.drone = droneF.value;
    if (pkgF && pkgF.value) params.package = pkgF.value;
    if (latF && latF.value) params.min_latency = latF.value;

    var data = await v3Get('/protocol', params);
    if (!data || !data.history) return;

    data.history.forEach(function(e) {
      wireEntries.push(e);
      if (e.id > wireLastId) wireLastId = e.id;
      // Track observed drones
      if (e.drone_id) wireObservedDrones.add(e.drone_id);
      if (e.source_node) wireObservedDrones.add(e.source_node);
    });

    // Cap at 2000 entries
    if (wireEntries.length > 2000) {
      wireEntries = wireEntries.slice(-2000);
    }

    renderWireTable();
    updateWireStats();
    populateWireDroneFilter();
  }

  function renderWireTable() {
    var tbody = $('#wire-tbody');
    if (!tbody) return;

    if (wireEntries.length === 0) {
      tbody.innerHTML = '<tr class="sv3-empty-row"><td colspan="8">No protocol data — waiting for traffic...</td></tr>';
      return;
    }

    tbody.innerHTML = wireEntries.map(function(e) {
      var ts = e.timestamp ? new Date(e.timestamp * 1000) : null;
      var timeStr = ts ? ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '--';
      var source = e.source_node || e.source_ip || '--';
      var arrow = (e.method === 'GET') ? '&larr;' : '&rarr;';
      var latClass = (e.latency_ms < 10) ? 'fast' : (e.latency_ms < 100 ? 'medium' : 'slow');
      var latStr = e.latency_ms != null ? e.latency_ms.toFixed(1) : '--';
      var summary = e.request_summary || (e.method + ' ' + e.path);
      var sel = (e.id === wireSelectedId) ? ' selected' : '';
      return '<tr data-type="' + esc(e.msg_type) + '" data-id="' + e.id + '" class="' + sel.trim() + '">' +
        '<td>' + e.id + '</td>' +
        '<td>' + esc(timeStr) + '</td>' +
        '<td>' + esc(source) + '</td>' +
        '<td style="text-align:center;">' + arrow + '</td>' +
        '<td>' + esc(e.msg_type) + '</td>' +
        '<td title="' + esc(summary) + '">' + esc(summary) + '</td>' +
        '<td><span class="sv3-wire-latency ' + latClass + '">' + latStr + 'ms</span></td>' +
        '<td>' + (e.status_code || '--') + '</td>' +
        '</tr>';
    }).join('');

    // Bind row click handlers
    tbody.querySelectorAll('tr[data-id]').forEach(function(row) {
      row.addEventListener('click', function() {
        var id = parseInt(row.dataset.id);
        wireSelectedId = id;
        tbody.querySelectorAll('tr').forEach(function(r) { r.classList.remove('selected'); });
        row.classList.add('selected');
        showWireDetail(id, wireDetailTab);
        // Highlight in topology
        var entry = wireEntries.find(function(e) { return e.id === id; });
        if (entry && entry.source_node) highlightTopoDrone(entry.source_node);
      });
    });

    // Auto-scroll
    if (wireAtBottom && wireLive) {
      var listWrap = $('#wire-list-wrap');
      if (listWrap) listWrap.scrollTop = listWrap.scrollHeight;
    }
  }

  async function showWireDetail(id, tab) {
    var content = $('#wire-detail-content');
    var empty = $('#wire-detail-empty');
    var header = $('#wire-detail-header');
    var jsonEl = $('#wire-json');
    if (!content || !empty || !header || !jsonEl) return;

    var data = await v3Get('/protocol/detail', { id: String(id) });
    if (!data) return;

    empty.style.display = 'none';
    content.style.display = 'block';

    var latClass = (data.latency_ms < 10) ? 'fast' : (data.latency_ms < 100 ? 'medium' : 'slow');
    header.innerHTML = '<strong>' + esc(data.method) + '</strong> ' + esc(data.path) +
      '  <span style="color:var(--cyan);">' + esc(data.msg_type) + '</span>' +
      '  <span class="sv3-wire-latency ' + latClass + '">' + (data.latency_ms || 0).toFixed(1) + 'ms</span>' +
      '  <span style="color:var(--text-dim);">' + (data.status_code || '') + '</span>';

    var json = '';
    if (tab === 'request') {
      json = data.request_body || '(no request body)';
    } else if (tab === 'response') {
      json = data.response_body || '(no response body)';
    } else {
      json = JSON.stringify({
        id: data.id,
        timestamp: data.timestamp,
        source_ip: data.source_ip,
        source_node: data.source_node,
        drone_id: data.drone_id,
        package: data.package,
        session_id: data.session_id,
        content_length: data.content_length,
        request_summary: data.request_summary,
        response_summary: data.response_summary,
      }, null, 2);
    }

    // Try to pretty-print JSON
    try {
      var parsed = JSON.parse(json);
      json = JSON.stringify(parsed, null, 2);
    } catch(e) {}

    jsonEl.innerHTML = syntaxHighlight(json);
  }

  function syntaxHighlight(json) {
    if (!json) return '';
    json = esc(json);
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
      var cls = 'sv3-json-number';
      if (/^"/.test(match)) {
        if (/:$/.test(match)) {
          cls = 'sv3-json-key';
        } else {
          cls = 'sv3-json-string';
        }
      } else if (/true|false/.test(match)) {
        cls = 'sv3-json-bool';
      } else if (/null/.test(match)) {
        cls = 'sv3-json-null';
      }
      return '<span class="' + cls + '">' + match + '</span>';
    });
  }

  function updateWireStats() {
    var el = $('#wire-stats');
    if (!el) return;
    var counts = {};
    wireEntries.forEach(function(e) {
      counts[e.msg_type] = (counts[e.msg_type] || 0) + 1;
    });
    var parts = ['Total: ' + wireEntries.length];
    Object.keys(counts).sort(function(a,b) { return counts[b] - counts[a]; }).forEach(function(t) {
      parts.push(t + ': ' + counts[t]);
    });
    el.textContent = parts.join(' | ');
  }

  function populateWireDroneFilter() {
    var sel = $('#wire-filter-drone');
    if (!sel) return;
    var current = sel.value;
    var drones = Array.from(wireObservedDrones).sort();
    var options = '<option value="">All Drones</option>';
    drones.forEach(function(d) {
      if (!d) return;
      options += '<option value="' + esc(d) + '"' + (d === current ? ' selected' : '') + '>' + esc(d) + '</option>';
    });
    sel.innerHTML = options;
  }

  function initWireResize() {
    var handle = $('#wire-resize-handle');
    var split = $('#wire-split');
    var listWrap = $('#wire-list-wrap');
    var detail = $('#wire-detail');
    if (!handle || !split || !listWrap || !detail) return;

    var startY, startDetailH;
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      startY = e.clientY;
      startDetailH = detail.offsetHeight;
      function onMove(ev) {
        var dy = startY - ev.clientY;
        var newH = Math.max(100, Math.min(split.offsetHeight - 100, startDetailH + dy));
        detail.style.height = newH + 'px';
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  }

  // ---- Topology <-> Wire Integration ----
  var topoLastProtoId = 0;

  function highlightTopoDrone(name) {
    // Find the topo path for this drone name and flash it
    var nodes = topoPrevDroneMap;
    if (!nodes || !nodes[name]) return;
    var idx = nodes[name].idx;
    var pathEl = document.getElementById('topo-path-' + idx);
    if (!pathEl) return;
    var origStroke = pathEl.getAttribute('stroke');
    var origWidth = pathEl.getAttribute('stroke-width');
    pathEl.setAttribute('stroke', '#06b6d4');
    pathEl.setAttribute('stroke-width', '3');
    setTimeout(function() {
      pathEl.setAttribute('stroke', origStroke);
      pathEl.setAttribute('stroke-width', origWidth);
    }, 2000);
  }

  function navigateToWireForDrone(droneName) {
    // Switch to Wire tab filtered to this drone
    $$('.sv3-tab').forEach(function(t) { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
    $$('.sv3-tab-content').forEach(function(c) { c.classList.remove('active'); });
    var wireTab = document.querySelector('.sv3-tab[data-tab="wire"]');
    if (wireTab) { wireTab.classList.add('active'); wireTab.setAttribute('aria-selected','true'); }
    var wirePanel = $('#tab-wire');
    if (wirePanel) wirePanel.classList.add('active');
    // Set drone filter
    var droneF = $('#wire-filter-drone');
    if (droneF) droneF.value = droneName;
    wireLastId = 0; wireEntries = []; pollWire();
  }

  async function pollTopoProtocol() {
    // Fetch recent protocol entries for topology packet animation
    var data = await v3Get('/protocol', { since: String(topoLastProtoId), limit: '50' });
    if (!data || !data.history) return;
    data.history.forEach(function(e) {
      if (e.id > topoLastProtoId) topoLastProtoId = e.id;
      // Map source_node to drone index
      var droneName = e.source_node || e.drone_id;
      if (!droneName || !topoPrevDroneMap[droneName]) return;
      var idx = topoPrevDroneMap[droneName].idx;
      if (e.msg_type === 'work_request' && e.package) {
        createTopoPacket(idx, 'request');
      } else if (e.msg_type === 'complete') {
        createTopoPacket(idx, 'complete');
      } else if (e.msg_type === 'register' && Math.random() < 0.3) {
        // Sample heartbeats at 30%
        createTopoPacket(idx, 'heartbeat');
      }
    });
  }

  // ---- Replay Mode ----
  var replayMode = false;
  var replayPlaying = false;
  var replaySpeed = 1;
  var replayCurrentTime = 0;
  var replayStartTime = 0;
  var replayEndTime = 0;
  var replayEntries = [];
  var replayDensity = [];
  var replayInterval = null;

  function initReplay() {
    var btn = $('#replay-mode-btn');
    if (btn) btn.addEventListener('click', toggleReplayMode);

    var playBtn = $('#replay-play');
    if (playBtn) playBtn.addEventListener('click', function() {
      if (replayPlaying) stopReplayPlay(); else startReplayPlay();
    });

    var startBtn = $('#replay-start');
    if (startBtn) startBtn.addEventListener('click', function() { replayJump(replayStartTime); });

    var endBtn = $('#replay-end');
    if (endBtn) endBtn.addEventListener('click', function() { replayJump(replayEndTime); });

    var backBtn = $('#replay-back');
    if (backBtn) backBtn.addEventListener('click', function() { replayStep(-10); });

    var fwdBtn = $('#replay-fwd');
    if (fwdBtn) fwdBtn.addEventListener('click', function() { replayStep(10); });

    var speedSel = $('#replay-speed');
    if (speedSel) speedSel.addEventListener('change', function() {
      replaySpeed = parseFloat(speedSel.value) || 1;
    });

    var scrubber = $('#replay-scrubber');
    if (scrubber) scrubber.addEventListener('input', function() {
      var pct = parseInt(scrubber.value) / 1000;
      var ts = replayStartTime + pct * (replayEndTime - replayStartTime);
      replayJump(ts);
    });
  }

  async function toggleReplayMode() {
    replayMode = !replayMode;
    var btn = $('#replay-mode-btn');
    var label = $('#replay-mode-label');
    var controls = $('#replay-controls');

    if (replayMode) {
      btn.classList.add('active');
      label.textContent = 'Live';
      controls.style.display = 'block';
      // Stop live refresh
      clearInterval(refreshTimer);
      refreshTimer = null;
      // Load replay data
      replayEndTime = Date.now() / 1000;
      replayStartTime = replayEndTime - 3600; // Last hour
      replayCurrentTime = replayStartTime;
      await loadReplayDensity();
      await loadReplayEntries();
      // Switch to Wire tab for replay
      $$('.sv3-tab').forEach(function(t) { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
      $$('.sv3-tab-content').forEach(function(c) { c.classList.remove('active'); });
      var wireTab = document.querySelector('.sv3-tab[data-tab="wire"]');
      if (wireTab) { wireTab.classList.add('active'); wireTab.setAttribute('aria-selected','true'); }
      var wirePanel = $('#tab-wire');
      if (wirePanel) wirePanel.classList.add('active');
      renderReplayFrame();
    } else {
      btn.classList.remove('active');
      label.textContent = 'Replay';
      controls.style.display = 'none';
      stopReplayPlay();
      // Resume live refresh
      wireLastId = 0; wireEntries = [];
      startRefresh();
    }
  }

  async function loadReplayDensity() {
    var data = await v3Get('/protocol/density', {
      start: String(replayStartTime),
      end: String(replayEndTime),
      buckets: '200'
    });
    if (data && data.density) {
      replayDensity = data.density;
      drawDensityCanvas();
    }
  }

  function drawDensityCanvas() {
    var canvas = $('#replay-density-canvas');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var w = canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
    var h = canvas.height = 40 * (window.devicePixelRatio || 1);
    ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
    var dw = canvas.clientWidth;
    var dh = 40;

    ctx.clearRect(0, 0, dw, dh);
    if (!replayDensity || replayDensity.length === 0) return;

    var max = Math.max.apply(null, replayDensity) || 1;
    var barW = dw / replayDensity.length;

    replayDensity.forEach(function(v, i) {
      var barH = (v / max) * (dh - 4);
      var x = i * barW;
      ctx.fillStyle = 'rgba(6, 182, 212, 0.4)';
      ctx.fillRect(x, dh - barH - 2, Math.max(1, barW - 1), barH);
    });
  }

  async function loadReplayEntries() {
    var data = await v3Get('/protocol', { limit: '5000' });
    if (data && data.history) {
      replayEntries = data.history.filter(function(e) {
        return e.timestamp >= replayStartTime && e.timestamp <= replayEndTime;
      });
    }
  }

  function startReplayPlay() {
    replayPlaying = true;
    var playBtn = $('#replay-play');
    if (playBtn) playBtn.innerHTML = '&#10074;&#10074;';
    replayInterval = setInterval(function() {
      replayCurrentTime += replaySpeed * 0.5;
      if (replayCurrentTime >= replayEndTime) {
        replayCurrentTime = replayEndTime;
        stopReplayPlay();
      }
      renderReplayFrame();
    }, 500);
  }

  function stopReplayPlay() {
    replayPlaying = false;
    var playBtn = $('#replay-play');
    if (playBtn) playBtn.innerHTML = '&#9654;';
    if (replayInterval) { clearInterval(replayInterval); replayInterval = null; }
  }

  function replayJump(ts) {
    replayCurrentTime = Math.max(replayStartTime, Math.min(replayEndTime, ts));
    renderReplayFrame();
  }

  function replayStep(seconds) {
    replayJump(replayCurrentTime + seconds);
  }

  function renderReplayFrame() {
    // Update time display
    var timeEl = $('#replay-time');
    if (timeEl) {
      var d = new Date(replayCurrentTime * 1000);
      timeEl.textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    // Update scrubber position
    var scrubber = $('#replay-scrubber');
    if (scrubber && replayEndTime > replayStartTime) {
      var pct = ((replayCurrentTime - replayStartTime) / (replayEndTime - replayStartTime)) * 1000;
      scrubber.value = Math.round(pct);
    }

    // Filter entries up to current time
    var visible = replayEntries.filter(function(e) {
      return e.timestamp <= replayCurrentTime;
    });

    // Feed into wire entries and render
    wireEntries = visible.slice(-2000);
    renderWireTable();
    updateWireStats();
  }

  // ---- Main refresh loop ----
  async function refresh() {
    if (replayMode) return;  // Don't refresh in replay mode

    // Only refresh the active tab + always overview status
    const activeTab = document.querySelector('.sv3-tab.active');
    const tab = activeTab ? activeTab.dataset.tab : 'overview';

    await renderOverview();

    // Poll activity feed alongside status
    pollActivityFeed();

    // Update CPU gauge from fleet data
    var fleetNodes = await v3Get('/nodes', { all: 'true' });
    if (fleetNodes && Array.isArray(fleetNodes)) {
      updateCPUGauge(fleetNodes);
    }

    // Build rate chart on overview tab
    if (tab === 'overview') {
      updateBuildRateChart();
    }

    if (tab === 'fleet') await renderFleet();
    if (tab === 'queue') await renderQueue();
    if (tab === 'history') {
      await renderHistory();
      renderDurationHistogram();
      renderDronePerformance();
    }
    if (tab === 'wire') {
      if (wireLive) await pollWire();
    }
    if (tab === 'topology') {
      if (!fleetNodes) {
        var topoNodes = await v3Get('/nodes', { all: 'true' });
        renderTopology(topoNodes);
      } else {
        renderTopology(fleetNodes);
      }
      var topoStatus = await v3Get('/status');
      updateTopoSidebar(topoStatus, fleetNodes);
      // Protocol-driven packets
      await pollTopoProtocol();
    }
  }

  function startRefresh() {
    refresh();
    refreshTimer = setInterval(refresh, REFRESH_MS);
  }

  // ---- Init ----
  initActivityPanel();
  initWireTab();
  initReplay();

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startRefresh);
  } else {
    startRefresh();
  }

  // Cleanup on page leave
  document.addEventListener('astro:before-swap', () => {
    clearInterval(refreshTimer);
    if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
    if (buildRateChartInstance) { buildRateChartInstance.destroy(); buildRateChartInstance = null; }
    if (topoAnimFrame) { cancelAnimationFrame(topoAnimFrame); topoAnimFrame = null; }
    if (replayInterval) { clearInterval(replayInterval); replayInterval = null; }
  });
})();
</script>
